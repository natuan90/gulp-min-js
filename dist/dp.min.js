!function(e,t){t(document);var i=skygate.util.format,r=skygate.util.date.toYmdString,a=skygate.util.date.ymdStringToObject,n=skygate.util.date.ymdStringToObjectWithSeparator,s=skygate.util.date.computeDate,o=skygate.util.date.diffDate,u=s(new Date,0),c=Backbone.Model.extend({reverseLookup:{},defaults:{destination:""},initialize:function(){this.directions=e.directions},getAreas:function(){return this.directions},getCountries:function(e){return this.directions[e].areas},getDefaultCountry:function(e){var t=this.directions[e];return 1===t.areas.length?t.areas[0].code:t.defaultArea},getCities:function(e,t){return this.directions[e].areas[t].cities},getDefaultCity:function(e,t){var i=this.directions[e].areas[t];return 1===i.cities.length?i.cities[0].code:i.defaultCity},getCorrespondingCountry:function(){var e=this._reverseLookup(this.get("destination"));return this.directions[e.directionIndex].areas[e.areaIndex]},getCorrespondingArea:function(){var e=this._reverseLookup(this.get("destination"));return this.directions[e.directionIndex]},_reverseLookup:function(e){if(this.reverseLookup[e])return this.reverseLookup[e];var t=this;return _.each(this.directions,function(i){_.each(i.areas,function(r){_.each(r.cities,function(a){t.reverseLookup[e]||e!==a.code||(t.reverseLookup[e]={directionIndex:Number(i.code),areaIndex:Number(r.code)})})})}),this.reverseLookup[e]||{}}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").DestinationModel=c;var h=Backbone.Model.extend({ABLE_TO_BUYING_NEXT_DAY_TIME:18,defaults:{fromDate:null,toDate:null,checkin:null,checkout:null},initialize:function(){var e=new Date;this.minDate=s(e,2)},setDate:function(e,t){var i=this._normalizeDateString(t);this.attributes[e]=i.split("/").join(""),this._adjust(e)},_normalizeDateString:function(e){if(!e)return e;if(-1===(e=_.reduce(["・","／","･"],function(e,t){return e.split(t).join("/")},e)).indexOf("/"))return e;var t=e.split("/"),i=t[1],r=t[2];return i&&1===i.length&&(i="0"+i),r&&1===r.length&&(r="0"+r),[t[0],i,r].join("/").replace(/[Ａ-Ｚａ-ｚ０-９]/g,function(e){return String.fromCharCode(e.charCodeAt(0)-65248)})},_adjust:function(e){var t=this.getDateObject("fromDate"),i=this.getDateObject("toDate"),a=this.getDateObject("checkin"),n=this.getDateObject("checkout");"fromDate"===e?t&&(i&&i<=t&&(i=s(t,1),this.set("toDate",r(i))),a&&s(a,1)<t&&(a=t,this.set("checkin",r(a)),n&&n<a&&(n=s(a,1),this.set("checkout",r(n))))):"toDate"===e?t&&i&&n&&t<i&&i<n&&(n=i,this.set("checkout",r(n)),a&&n<=a&&(a=s(n,-1),this.set("checkin",r(a)))):"checkin"===e?i&&a&&n&&a<i&&n<=a&&(n=s(a,1),this.set("checkout",r(n))):"checkout"===e&&t&&a&&n&&t<n&&n<=a&&(a=s(n,-1),this.set("checkin",r(a)))},getDateObject:function(e){var t=this.get(e);try{return a(t)}catch(e){return null}},getNumberOfStay:function(){var e=this.getDateObject("checkin"),t=this.getDateObject("checkout"),i=e&&t?o(t,e):0;return 0<i?i:null},getWithSeparator:function(e){var t=this.getDateObject(e);return t?r(t,"/"):this.get(e)},getCalendarMinDate:function(){var e=this.ABLE_TO_BUYING_NEXT_DAY_TIME<=(new Date).getHours()?s(new Date,1):new Date;return new Date(e.getFullYear(),e.getMonth(),e.getDate())},getCalendarMaxDate:function(){return new Date((new Date).getFullYear()+1,11,31)},isSameDate:function(e,t){return e.getFullYear()===t.getFullYear()&&e.getMonth()===t.getMonth()&&e.getDate()===t.getDate()}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").DateModel=h;var l=Backbone.Model.extend({ABLE_TO_BUYING_NEXT_DAY_TIME:18,DEFAULT_INTERVAL:3,CALENDAR_LIMIT:360,WEEK_RANGE:_.range(1,7),initialize:function(){this.from=this.getDefaultFromDate(this.ABLE_TO_BUYING_NEXT_DAY_TIME),this.fromWithoutTime=new Date(this.from.getFullYear(),this.from.getMonth(),this.from.getDate()),this.last=s(new Date,this.CALENDAR_LIMIT),this.lastSunday=0===this.last.getDay()?this.last:s(this.last,-1*this.last.getDay())},getDefaultFromDate:function(e){return(new Date).getHours()>=e?new Date:s(new Date,-1)},getDefaultToDate:function(e,t){return s(e,t)},getDateWithoutReturn:function(e){return this.getDefaultToDate(e,this.DEFAULT_INTERVAL)},_checkHoliday:function(e){return!!ktHolidayName(e)},_createDate:function(e,t,i){return{ng:t,day:e.getDate(),month:e.getMonth()+1,holiday:i,ymd:r(e,"/")}},getCalendarDates:function(){var e=[];e.push(this._createFirstWeek(this.fromWithoutTime));for(var t=s(this.fromWithoutTime,6-this.fromWithoutTime.getDay()+1);!(t>=this.lastSunday);)e.push(this._createNormalWeek(t)),t=s(t,7);return e.push(this._createLastWeek(this.last)),e},_createFirstWeek:function(e){var t=e;0!==e.getDay()&&(t=s(e,-e.getDay()));var i=[];return i.push(this._createDate(t,t<e)),_.reduce(this.WEEK_RANGE,function(i,r){var a=s(t,r);return i.push(this._createDate(a,e>a,this._checkHoliday(a))),i},i,this)},_createLastWeek:function(e){var t=e;0!==e.getDay()&&(t=s(e,-1*e.getDay()));var i=[];return i.push(this._createDate(t)),_.reduce(this.WEEK_RANGE,function(i,r){var a=s(t,r);return i.push(this._createDate(a,e<a,this._checkHoliday(a))),i},i,this)},_createNormalWeek:function(e){var t=e,i=[];return i.push(this._createDate(t)),_.reduce(this.WEEK_RANGE,function(e,i){var r=s(t,i);return e.push(this._createDate(r,!1,this._checkHoliday(r))),e},i,this)}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").CalendarModel=l;var d=Backbone.Model.extend({defaults:{roomMaxNum:4,rooms:[],roomDefault:{adult:1,childAges:[]}},initialize:function(){_.bindAll(this,"increment","decrement","setRoomNum","getRooms")},deserialize:function(e){return _.reduce(e.split(":"),function(e,t){var i=_.map(t.split(","),function(e){return parseInt(e,10)});return e.push({adult:i.shift(),childAges:i||[]}),e},[])},deserializeAndUpdate:function(e){var t=this.deserialize(e);return this.set("rooms",t),t},formatStr:function(e){var t=[];return _.each(e,function(e){var i=e.adult;e.childAges.length>0&&(i+=","+e.childAges.join(",")),t.push(i)}),t.join(":")},increment:function(){var e=this.get("rooms"),i=e.length;i<this.get("roomMaxNum")&&(e[i]=t.extend(!0,{},this.get("roomDefault")),this.trigger("change"))},decrement:function(){var e=this.get("rooms");1<e.length&&(e.pop(),this.trigger("change"))},setRoomNum:function(e){var i=this.get("roomMaxNum");if(1<=e&&e<=i){var r=this.get("rooms");if(r.length<e){var a=this.get("roomDefault");_.each(_.range(r.length,e),function(){r.push(t.extend(!0,{},a))})}else r.length=e;this.trigger("change")}},getRooms:function(){return this.formatStr(this.get("rooms"))},getRoomsAsObject:function(){var e=this.get("rooms");return _.each(e,function(e){e.adult=parseInt(e.adult,10),_.isEmpty(e.childAges)||_.each(e.childAges,function(t,i){e.childAges[i]=parseInt(t,10)})}),e},setRooms:function(e,t){this.get("rooms")[e]=t}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").RoomModel=d;var f=Backbone.Model.extend({query:{always:["form","searchWait","AgentCode","tab","differentDate","differentRegion","meta"],air:{full:["fromDate","toDate","departure","destination","arrival","rooms","direct","openFix","carriers","omitLcc","seatClass","airOrder","depTimes","airPage","searchKind"],cachekey:["airCacheKey"]},hotel:{full:["fromDate","toDate","rooms","regionId","destination","checkin","checkout","hotelSort","hotelPage"],cachekey:["hotelCacheKey"]},selectedItem:{clear:{air:"clearAir",hotel:"clearHotel"},cachekey:["selectedItemKey"]},setBeforeCheck:{checkin:{key:"differentDate"},checkout:{key:"differentDate"},regionId:{key:"differentRegion"}}},getUsableFormParams:function(e){var t=this.query,i=t.air.full,r=t.hotel.full,a=_.union(t.always,i,r);return this._getParams(e,a)},_getParams:function(e,t){var i=this;return _.reduce(t,function(t,r){return i._isVaildValue(e,r,t)?(t[r]=e[r],t):t},{})},_isVaildValue:function(e,t,i){if(this.query.setBeforeCheck[t])var r=e[this.query.setBeforeCheck[t].key]&&e[t]?e[t]:null;else r=e[t]?e[t]:null;return!_.isUndefined(r)&&null!==r&&""!==r}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").FilterCondition=f;var g=Backbone.Model.extend({TRAVELERS_NUMBER_LIMIT:9,errorMessage:{required:"{0}が指定されていません。",invalid:"{0}の指定が不正です。",invalidDate:"{0}は存在しない日付です。",pastDate:"{0}が過去日付です。",travelersMaxOver:"旅行者の最大人数は{0}名までです。"},initialize:function(){this.roomModel=new d},validate:function(e){var t=[],r=this._validateDate(e,t);return this._validateCheckinout(e,t,r),e.departure||t.push(i(this.errorMessage.required,"出発地")),e.destination||t.push(i(this.errorMessage.required,"目的地")),e.arrival||t.push(i(this.errorMessage.required,"帰国到着地")),this._validateRooms(e,t),t},_validateDate:function(e,t){var r=!1;if(e.fromDate)if(this._isValidDate(e.fromDate))if(this._isPastDate(e.fromDate,0))t.push(i(this.errorMessage.pastDate,"出発日")),r=!0;else if(e.toDate)if(this._isValidDate(e.toDate))if(this._isPastDate(e.toDate,0))t.push(i(this.errorMessage.pastDate,"現地出発日")),r=!0;else{var a=n(e.fromDate);n(e.toDate)<=a&&(t.push(i(this.errorMessage.invalid,"出発日")),r=!0)}else t.push(i(this.errorMessage.invalidDate,"現地出発日")),r=!0;else t.push(i(this.errorMessage.required,"現地出発日")),r=!0;else t.push(i(this.errorMessage.invalidDate,"出発日")),r=!0;else t.push(i(this.errorMessage.required,"出発日")),r=!0;return r},_validateCheckinout:function(e,t,r){if(e.differentDate)if(e.checkin)if(this._isValidDate(e.checkin))if(this._isPastDate(e.checkin,-1))t.push(i(this.errorMessage.pastDate,"チェックイン"));else if(e.checkout)if(this._isValidDate(e.checkout))if(this._isPastDate(e.checkout,0))t.push(i(this.errorMessage.pastDate,"チェックアウト"));else{var a=n(e.checkin),o=n(e.checkout);if(o<=a)t.push(i(this.errorMessage.invalid,"チェックイン"));else if(!r){var u=n(e.fromDate),c=n(e.toDate);(a<s(u,-1)||c<o)&&t.push("チェックイン・チェックアウトは、出発日・現地出発日の間からお選びください。")}}else t.push(i(this.errorMessage.invalidDate,"チェックアウト"));else t.push(i(this.errorMessage.required,"チェックアウト"));else t.push(i(this.errorMessage.invalidDate,"チェックイン"));else t.push(i(this.errorMessage.required,"チェックイン"))},_isValidDate:function(e){if(!e)return!1;try{if(-1===e.indexOf("/")){if(8!==e.length)return!1;var t=[e.substring(0,4),e.substring(4,6),e.substring(6,8)]}else t=e.split("/");var i=new Date(t[0],+t[1]-1,t[2]);return null!==i&&i.getFullYear()===+t[0]&&i.getMonth()+1===+t[1]&&i.getDate()===+t[2]}catch(e){return!1}},_isPastDate:function(e,t){if(-1===e.indexOf("/")){if(8!==e.length)return!1;var i=[e.substring(0,4),e.substring(4,6),e.substring(6,8)]}else i=e.split("/");return new Date(i[0],+i[1]-1,i[2])<s(u,t)},_validateRooms:function(e,t){var r=this.roomModel.deserialize(e.rooms),a=_.reduce(r,function(e,t){return e+=t.adult+t.childAges.length},0);this.TRAVELERS_NUMBER_LIMIT<a?t.push(i(this.errorMessage.travelersMaxOver,this.TRAVELERS_NUMBER_LIMIT)):_.reduce(r,function(e,t){return e+=t.adult},0)<_.reduce(r,function(e,t){return e+=t.childAges.length},0)&&t.push("子供、幼児人数が大人人数を超えています。")}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").ValidateCondition=g;var m=Backbone.Model.extend({DEFAULT_ADD_TODATE:3,getInitialParameter:function(e){var i=t.extend(!0,{},e),a=this._getInitialFromDate(e);i.fromDate=r(a);var n=e.toDate||this.DEFAULT_ADD_TODATE,o=s(a,n);i.toDate=r(o),i=t.extend(this._getInitialCheckinOut(e,a,o),i);var u=this._getInitialRooms(e);return i.rooms=u,i.departure=e.departure||"TYO",i.arrival=e.arrival||e.departure,i},_getInitialFromDate:function(e){var t=e.fromDate;if(t){if(_.isString(t))return-1===t.indexOf("/")?a(t):n(t);if(_.isNumber(t)){var i=new Date;return s(i,t)}}i=new Date;return new Date(i.getFullYear(),i.getMonth()+1,15)},_getInitialCheckinOut:function(e,t,i){return e.checkin&&e.checkout?{checkin:e.checkin.replace(/\u002f/g,""),checkout:e.checkout.replace(/\u002f/g,"")}:{checkin:r(t),checkout:r(i)}},_getInitialRooms:function(e){return e.rooms?_.reduce(e.rooms,function(e,t){return e.push({adult:t.adultNum,childAges:t.minorAges||[]}),e},[]):[{adult:2,childAges:[]}]},getSearchConditionKey:function(e){return e+"_"+location.host+location.pathname},saveCondition:function(t,i){var r=e.sessionStorage;if(!r)return!1;try{r.setItem(this.getSearchConditionKey(t),JSON.stringify(i))}catch(e){return!1}return!0},getSavedCondition:function(i){var r=e.sessionStorage;if(r)try{var a=r.getItem(this.getSearchConditionKey(i));if(a)return t.parseJSON(a)}catch(e){return}}});skygate.util.namespace("airlink.model.common.multi_search_form.dp").AirAndHotelFormModel=m}(window,jQuery);