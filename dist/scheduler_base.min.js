!function(e,i){var t=i(document),p=Backbone.View.extend({initialize:function(e){_.bindAll(this,"begin","_begin","skip","hidePopup"),e=e||{},this.id=e.id,this.$popups=this.$(".targetPopup"),this.popups=this._makeProcedure(),this.sequence=0,this.once=!!e.once,this.newSequenceEventName="Popup:New",this.id&&(this.newSequenceEventName+=":"+this.id),t.on(this.newSequenceEventName,this._begin),t.on("Popup:Skip",this.skip),t.on("Popup:Hide",this.hidePopup)},_makeProcedure:function(){var e=[],t=this._namespace("airlink.view.common.promo.popup.views");return this.$popups.each(function(){var p=i(this),n=p.data("name"),s=t[n];if(!s)return!0;var o=new s({el:p,name:n});e.push({$popup:p,view:o,deltaBefore:p.data("deltaBefore")||0,deltaAfter:p.data("deltaAfter")||0,expire:p.data("expire"),group:p.data("group"),banishGroup:p.data("banishGroup"),openTag:p.data("openTag")})}),e},begin:function(e){t.trigger(this.newSequenceEventName,e)},_begin:function(e,i){if(!(this.once&&this.sequence>0)){this.sequence++,this.sequenceId=(this.id||"s")+this.sequence,this.popupIndex=void 0,_.each(this.popups,function(e,t){e.$popup.html("").hide(),e.view.fetch(this.sequenceId,t,i)},this),this.$el.show(),this.poppedGroups=[];var t=this;_.defer(function(){t.deltaAfter=0,t.previousPopupAt=(new Date).getTime(),t._reservePopup(t.sequenceId,0)})}},_reservePopup:function(e,i){if(this.popupIndex=i,!(i>=this.popups.length)){var t=this.popups[i];if(""===t.view.get(e)||t.group&&_.contains(this.poppedGroups,t.group)||t.banishGroup&&this._isBanish(t.banishGroup))this._reservePopup(e,i+1);else{var p=this.deltaAfter+t.deltaBefore-((new Date).getTime()-this.previousPopupAt),n=Math.max(p,0),s=this;_.delay(function(){t.view.get(e,function(t){s._isCurrentSequence(e)&&s._isCurrentPopup(i)&&s._addPopup(e,i,t)}),s.sendTag(t.openTag)},n)}}},_addPopup:function(e,i,t){var p=this.popups[i];if(t){if(p.$popup.hide().html(t).removeData("removing"),this._showPopup(e,p.$popup),p.expire){var n=this;_.delay(function(){n._isCurrentSequence(e)&&n._hidePopup(e,p.$popup)},p.expire)}this.deltaAfter=p.deltaAfter,this.previousPopupAt=(new Date).getTime(),p.group&&this.poppedGroups.push(p.group),this._reservePopup(e,i+1)}else this._reservePopup(e,i+1)},skip:function(e,i){this._isCurrentSequence(i.sequenceId)&&this._isCurrentPopup(i.popupIndex)&&this._reservePopup(this.sequenceId,this.popupIndex+1)},hidePopup:function(e,t){var p=i(t);if(this._isOwnerOf(p)&&!p.data("removing")){this._hidePopup(this.sequenceId,p),p.data("removing",!0);var n=p.data("banishGroup");n&&this._addBanish(n),this.sendTag(p.data("closeTag"))}},_isCurrentSequence:function(e){return e===this.sequenceId},_isCurrentPopup:function(e){return e===this.popupIndex},_publishShowedMessage:function(e,i){this._isCurrentSequence(e)&&t.trigger("Popup:Showed",i[0])},_publishHidMessage:function(e,i){(!e||this._isCurrentSequence(e))&&t.trigger("Popup:Hid",i[0])},_isOwnerOf:function(e){return _.some(this.popups,function(i){return e.is(i.$popup)})},_namespace:function(i){var t=e;return _.some(i.split("."),function(e){return!(t=t[e])}),t||{}},_isBanish:function(e){throw new Error("override me")},_addBanish:function(e){throw new Error("override me")}}),n={sendTag:function(e){e&&2===e.type&&this.googleAnalytics(e.data)},googleAnalytics:function(e){!_.isEmpty(e)&&_.isArray(e)&&ga.apply(null,e)}};Cocktail.mixin(p,n),skygate.util.namespace("airlink.view.common.promo.popup").PopupSchedulerBaseView=p}(window,jQuery);