!function(e,t){var i=skygate.util.format,a=skygate.util.date.computeDate,o=skygate.util.date.toYmdString,r=skygate.util.date.ymdStringToObject,n=skygate.util.date.ymdStringToObjectWithSeparator,s=(skygate.util.objectToQueryParameters,skygate.util.escapeHTML),l=airlink.model.common.ui_integration_multi_search_form,d=airlink.view.ui_integration_multi_search_form.components,c=(l.MultiSearchFormBaseView,l.AirAndHotelFormModel),h=l.AirFormView,u=l.HotelViewMixin,p=d.AirSuggestionView,g=l.CityModalView,f=l.CityHotelModalView,m=l.datepickerSettings,v=l.escapeRegex,D=h.extend({roomSettingText:"大人{0}名、子供・幼児{1}名",DEFAULT_ROOMS:[{adultNum:1}],events:{"click .search":"searchAirAndHotel","change .destinationDomestic":"changeDestinationDomestic","click  .date-picker":"showDatepicker","change .fromDate, .toDate":"changeDate","change .checkin, .checkout":"changeHotelDate","change .airAutocompleteTarget":"clearPlaceholder","focus .hotelDpAutocompleteTarget":"clearHotelAutocomplete","change .anotherSchedule":"showOrHideHotelDate","click .clear-text-target-hotel-dp":"clearTextTargetHotelDp","keyup .hotelDpAutocompleteTarget":"showClearInputHotelDp","keyup .departureDomestic, .destinationDomestic":"showClearInputDp","change .roomNum":"changeRoomDP","change .childNum":"changeChild","click .input-set-number":"openModalRoomContent","click .close-modal":"closeModalRoomContent","click .btn-minus-adult":"decreaseAdult","click .btn-plus-adult":"increaseAdult","click .btn-minus-child":"decreaseChild","click .btn-plus-child":"increaseChild","click .optionalCondition":"showOrHideOptionalCondition","click .targetAreaSuggestModalClose":"closeModal","click .searchFromModal":"searchFromModal","keyup .js-set-city":"showRecommendOrSuggest","click .ui-menu-item":"selectSuggestCityInputManual"},initialize:function(i){_.bindAll(this,"searchAirAndHotel","showDatepicker","showOrHideOptionalCondition","clearPlaceholder","changeDate","searchFromModal"),this.model=new c,this.model.setup(),this.template=_.template(this.$el.find(".suggestTemplate").html()),t("body").mouseup(function(e){var i=t("section.airAndHotelFormContainer div.modal-room-content");i.is(e.target)||0!==i.has(e.target).length||i.hide()});var a=this.model.getDefaultFromAndToDate();this.$el.find(".fromDate").val(a.from),this.model.setDate("checkin",a.from),this.$el.find(".toDate").val(a.to),this.model.setDate("checkout",a.to),this.setStayNum(this.model),this._clearParameter(),this._setupHotelDPSuggest(),_.each(this.$el.find(".selectDomesticAirport"),function(e){t(e).html(this._getDomesticAirports())},this),_.each(this.$el.find(".abroadArea"),function(e){t(e).html(this._getAreas())},this);var o=this.getInitialParameter();o&&(o=this._convertInitialParameter(o));var r=this.model.getSavedCondition(this.getContainerId()),n=r||o;if(n){n.AgentCode||(n.AgentCode=o.AgentCode);var s=this;_.defer(function(){s.restoreCondition(n),s._setupDatepicker(s.model.get("from")),s._setupHotelDatepicker(),n.checkin||n.checkout||s._syncHotelDate()})}else this._setupDatepicker(this.model.get("from")),s.model.setDate("checkout",s.model.get("checkout")),this._setupHotelDatepicker(),this._syncHotelDate();var l=e.airRecommendCityList||{};_.each(this.$el.find(".departure"),function(e,t){new g({el:e,optionData:{recommendCityList:l.departure||{},isDeparture:!0}})}),_.each(this.$el.find(".arrival"),function(e,t){new g({el:e,optionData:{recommendCityList:{domestic:[],abroad:l.destination.abroad||{}},isDeparture:!1}})});var d=e.hotelRecommendCityList;d&&_.each(this.$el.find(".search-hotel"),function(e,t){new f({el:e,optionData:{hotelCities:d.hotelCities||{}}})}),this.listenTo(this.model,"change:stayNum",this.setStayNum)},showHideModalPopularCities:function(e){if(e)this.$el.find(".js-set-hotel-modal").hide();else{var t=this.$el.find(".hotelAutocompleteTarget"),i=t.data("regionid");t.val()&&t.val().length&&!i?this.$el.find(".js-set-hotel-modal").hide():this.$el.find(".js-set-hotel-modal").show()}},_setupHotelDPSuggest:function(){var e=this;this.setupAutocomplete(t(".hotelDpAutocompleteTarget"),{source:function(i,a){var o=t.trim(i.term);o.length<2||e.model.suggest(o).done(function(t){var i=e.createSuggestData(t.result);return a(i)})},select:function(e,i){var a=t(e.currentTarget).find(".ui-state-focus").parent(),o=a.data("regionid"),r=a.data("hotelcode"),n=a.data("suggestlabel"),s=t(this);s.attr("data-regionId",o),s.attr("data-hotelCode",r),s.attr("data-suggestLabel",n)},appendTo:".sgt-dep-dp",position:{within:t(this).closest(".input-text-base").find(".sgt-dep")},open:function(e,i){var a=t(e.target).closest(".input-text-base");t(a).find(".set-hotel").addClass("show").addClass("ui-autocomplete"),t(a).find("ul.ui-autocomplete").addClass("list-suggest-01"),t(a).find("ul.list-suggest-01").attr("style",""),t(a).find(".set-departure").hide()},close:function(e,i){var a=t(e.target).closest(".input-text-base");t(a).find(".set-hotel").removeClass("show")},response:function(e,i){t("span.ui-helper-hidden-accessible").addClass("none")}}),t(".hotelDpAutocompleteTarget").data("ui-autocomplete")._renderItem=function(e,i){var a=this.element.val(),o=new RegExp(v(a),"ig"),r=i.label.replace(o,"<span>$&</span>");if(_.isObject(i.value)){var n=i.value;i.value=i.label,r='<span class="val">'+r+"</span>",n.categoryFirstClass&&(r+='<span class="'+n.categoryFirstClass+'">'+n.type+"</span>");var s=t("<li></li>").data("item.autocomplete",i).append(t("<a></a>").html(r)).appendTo(e);return n.isCategoryLast&&n.needMarkupLast&&s.addClass("last-item"),n.hotelCode?s.attr("data-hotelCode",n.hotelCode):s.attr("data-regionId",n.regionId),s.attr("data-suggestLabel",i.label),s}return t("<li></li>").data("item.autocomplete",i).append(t("<a></a>").html('<span class="val">'+r+"</span>")).appendTo(e)}},clearTextTargetHotelDp:function(e){this.$el.find("input.hotelDpAutocompleteTarget").val(""),this.$el.find("input.hotelDpAutocompleteTarget").removeAttr("data-regionId"),this.$el.find("input.hotelDpAutocompleteTarget").removeAttr("data-suggestLabel"),this.$el.find("input.hotelDpAutocompleteTarget").removeAttr("data-hotelCode"),t(e.currentTarget).hide(),this.showHideModalPopularCities()},showClearInputHotelDp:function(e){var i=t(e.currentTarget),a=i.val(),o=!0,r=t(i).attr("data-suggestLabel");if(""!=a){if(i.attr("data-suggestLabel",a),this.$el.find(".clear-text-target-hotel-dp").show(),a.length<2||a===r)return}else o=!1,i.removeAttr("data-regionId"),i.removeAttr("data-hotelCode"),i.removeAttr("data-suggestLabel"),this.$el.find(".clear-text-target-hotel-dp").hide();this.showHideModalPopularCities(o)},showClearInputDp:function(e){var i=t(e.currentTarget),a=i.closest(".input-text-base");""!=i.val()?(a.find(".clear-text").show(),i.attr("data-suggestLabel",i.val())):(i.removeAttr("data-cityCode"),i.removeAttr("data-suggestLabel"),a.find(".clear-text").hide(),a.find(".modal-city-popular").show())},restoreCondition:function(e){e.AgentCode&&this.$el.find(".AgentCode").val(e.AgentCode),e.fromDate&&(this.$el.find(".fromDate").val(e.fromDate),this.model.setDate("checkin",e.fromDate)),e.toDate&&(this.$el.find(".toDate").val(e.toDate),this.model.setDate("checkout",e.toDate)),e.departure&&(this.$el.find(".departureDomestic").attr("data-cityCode",e.departure),this.$el.find(".departureDomestic").attr("data-suggestLabel",e.departureLabel),this.$el.find(".departureDomestic").val(e.departureLabel),this._setupDepartureOrDestination(this.$el.find(".departureDomestic").get(0),e.departure),e.arrival||(this.$el.find(".arrivalDomestic").attr("data-cityCode",e.departure),this.$el.find(".arrivalDomestic").attr("data-suggestLabel",e.departureLabel),this.$el.find(".arrivalDomestic").val(e.departureLabel)),this.$el.find(".arrival .clear-text").show()),e.arrival&&(this.$el.find(".arrivalDomestic").attr("data-cityCode",e.arrival),this.$el.find(".arrivalDomestic").attr("data-suggestLabel",e.arrivalLabel),this.$el.find(".arrivalDomestic").val(e.arrivalLabel),this.$el.find(".arrival .clear-text").show()),e.destination&&(this.$el.find(".destinationDomestic").attr("data-cityCode",e.destination),this.$el.find(".destinationDomestic").attr("data-suggestLabel",e.destinationLabel),this.$el.find(".destinationDomestic").val(e.destinationLabel),this._setupDepartureOrDestination(this.$el.find(".destinationDomestic").get(0),e.destination),this.$el.find(".departure .clear-text").show()),e.roomSettings&&this._setupRooms(e.roomSettings),e.checkin&&e.checkout&&(this.$el.find(".checkin").val(e.checkin),this.$el.find(".checkout").val(e.checkout),this.model.setDate("checkin",e.checkin),this.model.setDate("checkout",e.checkout),this.$el.find(".anotherSchedule").prop("checked","checked").change());var t=!1,i=this.$el.find(".add-condition-container");if(e.suggestLabel&&e.regionId){var a=this.$el.find(".hotelDpAutocompleteTarget");a.val(e.suggestLabel),a.attr("data-suggestLabel",e.suggestLabel),a.attr("data-regionId",e.regionId),this.$el.find(".clear-text-target-hotel-dp").show(),t=!0}e.seatClass&&(i.find(".seatClass").val(e.seatClass),t=!0),e.carriers&&(i.find(".carriers").val(e.carriers),t=!0),t&&this._setupOptionalConditionContainer(!0)},_convertInitialParameter:function(e){var i=t.extend({},!0,e),s=e.fromDate;s&&_.isString(s)&&-1===s.indexOf("/")?i.fromDate=o(r(s),"/"):s&&_.isNumber(s)&&(i.fromDate=o(a(this.model.get("from"),s),"/"));var l=e.toDate,d=i.fromDate?n(i.fromDate,"/"):this.model.get("from");return i.toDate=o(a(d,l||this.model.DEFAULT_INTERVAL),"/"),e.rooms&&(i.roomSettings=e.rooms),i},_setupDestination:function(e,t){var i=this.model.get("reverseDirections")[t];if(i){var a=e.find(".abroadArea"),o=e.find(".abroadCountry"),r=e.find(".abroadPort");a.val(i.areaIndex),a.change(),o.val(i.countryIndex),o.change(),r.val(t),r.change()}},_setupOptionalConditionContainer:function(e){var t=this.$el.find(".optionalCondition").find("span");this._showOrHideOptionalIconElment(t,e),this._showOrHideOptionalCondition(e)},_setupDatepicker:function(e){this._datepicker(e,[this.$el.find(".fromDate"),this.$el.find(".toDate")])},_setupHotelDatepicker:function(){this._hotelDatepicker(this.$el.find(".checkin"),this.$el.find(".checkout"))},_hotelDatepicker:function(e,i){var r=this,s=t.extend(!0,{},m);s.beforeShow=function(s,l){var d,c=r.$el.find(".fromDate").val(),h=n(i.val());try{d=o(a(h,-1),"/")}catch(e){d=o(r.model.get("to"),"/")}e.datepicker("option","minDate",c),e.datepicker("option","maxDate",d);var u=t(e).closest(".js-calendar");t(u).find("#ui-datepicker-div")&&t(u).remove("#ui-datepicker-div"),t(u).append(t("#ui-datepicker-div"))},t(e).datepicker(s);var l=t.extend(!0,{},m);l.beforeShow=function(s,l){var d,c=r.$el.find(".toDate").val(),h=n(e.val());try{d=o(a(h,1),"/")}catch(e){d=o(r.model.get("from"),"/")}i.datepicker("option","minDate",d),i.datepicker("option","maxDate",c);var u=t(i).closest(".js-calendar");t(u).find("#ui-datepicker-div")&&t(u).remove("#ui-datepicker-div"),t(u).append(t("#ui-datepicker-div"))},t(i).datepicker(l)},_createSearchCondition:function(){var e={departure:this._getDeparturePort().value,departureLabel:this._getDeparturePort().label,arrival:this._getDeparturePort().value,arrivalLabel:this._getDeparturePort().label,destination:this._getDestination().value,destinationLabel:this._getDestination().label,fromDate:this.$el.find(".fromDate").val(),toDate:this.$el.find(".toDate").val(),AgentCode:this.$el.find(".AgentCode").val()},i=+this.$el.find(".roomNum").val(),a=this.$el.find(".roomContent");e.roomSettings=_.reduce(_.range(0,i),function(e,i){var o=t(a.get(i)),r=+parseInt(o.find(".adultNum").html()),n=+parseInt(o.find(".childNum").html()),s=[];if(n>0){var l=o.find(".childAge");s=_.reduce(_.range(0,n),function(e,i){var a=t(l.get(i));return e.push(+a.val()),e},s)}return e.push({adultNum:r,minorAges:s}),e},[]),this.$el.find(".anotherSchedule").is(":checked")&&(e.checkin=this.$el.find(".checkin").val(),e.checkout=this.$el.find(".checkout").val());var o=this.$el.find(".hotelDpAutocompleteTarget"),r=o.val();if(r.length>0&&"都市・地域・空港名などを入力してください"!==r){e.needHotelArea=!0;var n=o.data("regionid"),s=o.attr("data-suggestLabel");s&&n&&(e.regionId=n,e.suggestLabel=s)}var l=this.$el.find(".seatClass").val();l&&(e.seatClass=l);var d=this.$el.find(".carriers").val();return d&&(e.carriers=d),e},setStayNum:function(e){"-"!==this.model.get("stayNum")?this.$el.find(".day-count").html(i("{0}泊",this.model.get("stayNum"))):this.$el.find(".day-count").html("")},changeDate:function(e){var i,r=t(e.currentTarget),s=r.val();s=this.model.normalizeDateString(s),r.val(s);try{i=n(s)}catch(e){}if(i){var l=this.$el.find(".toDate");if(r.get(0)!==l.get(0))i>=n(l.val())&&l.val(o(a(i,1),"/")),this.scrollTo(t("#ui-datepicker-div")),_.defer(function(){l.focus()});this._syncHotelDate()}},_checkHotelDestinationHotelDp:function(){var e=this.$el.find(".hotelDpAutocompleteTarget"),i=t.trim(e.val());return 0===i.length||"都市・地域・空港名などを入力してください。"===i?this.hotelSuggestErrorMessage:i.length<2?"都市・ランドマーク・空港名・空港コード・ホテル名を正しく入力してください。":void 0},_getSuggestDataHotelDp:function(e){var t=this._checkHotelDestinationHotelDp(),i=[];if(t)return i.push({message:t,type:".error-hotel-dp-target"}),void this._handleErrorMessage(i);var a=this.$el.find(".hotelDpAutocompleteTarget").val(),o=this.model.suggest(a),r=this;o.done(function(e){if(!_.flatten(e.result).length){return i.push({message:"都市・ランドマーク・空港名・空港コード・ホテル名を正しく入力してください。",type:".error-hotel-dp-target"}),void r._handleErrorMessage(i)}r._showSuggestModal(e.result)})},changeRoomDP:function(e){var i=+t(e.currentTarget).val(),a=this.$el.find(".roomContent"),o="";_.each(_.range(0,4),function(e){var i=t(a.get(e)).find(".err-text-01");i.hasClass("error-roomsetting")&&(o=i.html())}),_.each(_.range(0,4),function(e){var r=t(a.get(e)),n=r.find(".err-text-01");e===i-1?(n.addClass("error-roomsetting"),n.html(o),n.show()):(n.removeClass("error-roomsetting"),n.hide()),e>=i?r.hide():(r.show(),r.css("display","inline-block"))})},setHotelDayModel:function(){var e=this.model.normalizeDateString(this.$el.find(".checkin").val()),t=this.model.normalizeDateString(this.$el.find(".checkout").val());this.model.setDate("checkin",e),this.model.setDate("checkout",t)},changeHotelDate:function(e){var i,r=t(e.currentTarget),s=r.val();s=this.model.normalizeDateString(s),r.val(s);try{i=n(s)}catch(e){}if(i){var l=this.$(".checkout");if(r.get(0)!==l.get(0))i>=n(l.val())&&l.val(o(a(i,1),"/")),_.defer(function(){l.focus()});this.setHotelDayModel()}},_syncHotelDate:function(){this.$el.find(".checkin").datepicker("setDate",this.$el.find(".fromDate").val()),this.$el.find(".checkout").datepicker("setDate",this.$el.find(".toDate").val()),this.setHotelDayModel()},showOrHideHotelDate:function(e){var i=t(e.currentTarget),a=this.$el.find(".hotelScheduleContainer");i.is(":checked")?a.show():a.hide()},searchAirAndHotel:function(){var e=this._createSearchCondition();this.$("[class^='err-text']").hide();var t=this.model.validate(e);if(t.length)return this._handleErrorMessage(t),!1;!e.needHotelArea||e.regionId&&e.suggestLabel?this._search(e):this._getSuggestDataHotelDp(e)},_search:function(e){this.model.saveCondition(this.getContainerId(),e),this.saveTabIndex();var t="/dp/list?"+this.model.createQueryParameter(e);location.href=t},searchFromModal:function(e){var t=this.$el.find(".targetAreaSuggestModal"),i=t.find("input[name=modalSuggestTarget]:checked"),a=this.$el.find(".hotelDpAutocompleteTarget"),o=i.data("suggestlabel");a.attr("data-regionId",i.data("regionid")),a.attr("data-suggestLabel",o),t.hide(),this.searchAirAndHotel()},showRecommendOrSuggest:function(e){""==t(e.currentTarget).val()&&t(".str-search .list-area-01 > li").css({"background-color":"#fff"}),this._displayAutoTab(e)},_displayAutoTab:function(e,i){var a=i?e:e.currentTarget,o=e.keyCode,r=i?"click":e.type;if(("keyup"===r||"click"===r)&&!o){var n=t(a).closest(".input-text-base").parent(),s=t(n).find("input.destinationDomestic");s.trigger("click"),s.focus(),t(a).closest(".input-text-base").hasClass("arrival")&&(t(".fromDate").focus(),this.scrollTo(t("#ui-datepicker-div")))}},selectSuggestCityInputManual:function(e){var i=t(e.currentTarget).closest(".js-city-suggest-modal").parent(),a=t(i).find("input.js-set-city")[0];this._displayAutoTab(a,!0),t(e.currentTarget).closest(".input-text-base").find(".modal-city-popular").hide()},_handleErrorMessage:function(e){_.each(e,function(e,t){var a=i("<strong>{0}</strong>",s(e.message));this.$(e.type).html(""),this.$(e.type).html(a).show()})},_hideErrorMessage:function(e){this.$el.find(".error-alert").hide().empty()},_getOptionalConditionContainer:function(){return this.$el.find(".add-condition-container")},_getDeparturePort:function(){var e={};return e.value=this.$el.find(".departureDomestic").attr("data-cityCode"),e.label=this.$el.find(".departureDomestic").attr("data-suggestLabel"),e},_getArrivalPort:function(){return this.$el.find(".arrivalDomestic").attr("data-cityCode")},showOrHideOptionalCondition:function(e){var i=t(e.currentTarget).find("span"),a=i.hasClass("close");this._showOrHideOptionalIconElment(i,a),this._showOrHideOptionalCondition(a)},_showOrHideOptionalIconElment:function(e,t){t?(e.removeClass("close"),e.addClass("open")):(e.removeClass("open"),e.addClass("close"))},_showOrHideOptionalCondition:function(e){var t=this.$el.find(".add-condition-container");e?t.show():t.hide()},showDatepicker:function(e){t(e.currentTarget).find("input").focus(),this.scrollTo(t("#ui-datepicker-div"))},clearPlaceholder:function(e){var i=t(e.currentTarget);"都市名、都市コードを入力"===i.val()&&i.val("")},_getDomesticAirports:function(){if(!this._domesticAirports){var e=_.reduce(this.model.get("domesticAirports"),function(e,t){return e.push(i('<option value="{0}">{1}</option>',t.code,t.label)),e},[]);this._domesticAirports=e.join("")}return this._domesticAirports},_getAreas:function(){if(!this.areas){var e=_.reduce(this.model.get("directions"),function(e,t){return e.push('<option value="'+t.code+'">'+t.name+"</option>"),e},[]);e.unshift('<option value="">方面を選択</option>'),this._areas=e.join("")}return this._areas},_getCountries:function(e){if(this._countries||(this._countries={}),""===e)return{countries:'<option value="">↑方面を選択</option>'};if(!this._countries[e]){var t=_.reduce(directions[e].areas,function(e,t){return e.push('<option value="'+t.code+'">'+t.name+"</option>"),e},[]);t.unshift('<option value="">↑方面を選択</option>'),this._countries[e]=t.join("")}return{countries:this._countries[e],noChoice:1===this._getDirections()[e].areas.length,defaultCountry:this._getDirections()[e].defaultArea}},_getPorts:function(e,t){if(this._ports||(this._ports={}),""===e||""===t)return{ports:'<option value="">↑方面を選択</option>'};var i=e+t;if(!this._ports[i]){var a=_.reduce(directions[e].areas[t].cities,function(e,t){return e.push('<option value="'+t.code+'">'+t.name+"</option>"),e},[]);a.unshift('<option value="">↑方面を選択</option>'),this._ports[i]=a.join(""),this._ports[i]={ports:a.join(""),noChoice:2==a.length,defaultCity:directions[e].areas[t].defaultCity}}return this._ports[i]},_getDestination:function(){var e={};return e.value=this.$el.find(".destinationDomestic").attr("data-cityCode"),e.label=this.$el.find(".destinationDomestic").attr("data-suggestLabel"),e},_getMinorAges:function(e){var i=e||this.currentContent,a=+i.find(".totalChildNum").val();if(0!==a){var o=i.find(".childAge");return _.reduce(o,function(e,i,o){var r=t(i);return a>o&&e.push(r.val()),e},[])}},_clearParameter:function(){var e=this;_.defer(function(){e.$el.find("select").prop("selectedIndex",0)}),this.$el.find("input[type=checkbox]").prop("checked",!1)}});_.extend(D.prototype,u),l.AirAndHotelFormView=D,t(function(){_.each(t(".airAndHotelFormContainer"),function(e){new D({el:e})}),_.each(t(".airAndHotelFormContainer").find(".departure"),function(e,t){new p({el:e,suggestion:{exceptList:["KIX","ITM"]}})}),_.each(t(".airAndHotelFormContainer").find(".arrival"),function(e,t){new p({el:e,suggestion:{exceptList:["KIX","ITM"]}})})})}(window,jQuery);