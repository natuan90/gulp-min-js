!function(e,t){var r=skygate.util.uuid,i=skygate.util.format,a=skygate.util.date.computeDate,s=skygate.util.date.toYmdString,n=(skygate.util.date.ymdStringToObject,skygate.util.date.ymdStringToObjectWithSeparator),o=skygate.util.objectToQueryParameters,u=airlink.model.common.multi_search_form,c=u.MultiSearchFormBaseModel.extend({ABLE_TO_BUYING_NEXT_DAY_TIME:18,DEFAULT_INTERVAL:3,googleAnalyticsSetting:{categoryPrefix:"AO_searchpanel_",target:{single:["departure","arrival","fromDate","totalNum","direct","carriers","seatClass","AgentCode","searchKind"],multi:["destinations","toDates","depTimes"]}},defaults:{from:null,to:null,domesticAirports:null,directions:null,directionsOverseas:null,reverseDirections:null,reverseDirectionsOverseas:null},setup:function(t){var r=this.attributes;r.from=t?this.getAbroadDefaultFrom():(new Date).getHours()>=this.ABLE_TO_BUYING_NEXT_DAY_TIME?a(new Date,1):new Date,r.to=a(r.from,this.DEFAULT_INTERVAL),r.domesticAirports=e.domesticAirportList||[],r.directions=e.directions||[],r.directionsOverseas=e.directionsOverSeas||[],r.reverseDirections=this.createReverseDirections(r.directions),r.reverseDirectionsOverseas=this.createReverseDirections(r.directionsOverseas)},hasEffectiveChildForDirection:function(e){var r=e.areas;return!(!r||0===r.length)&&!!_.find(r,function(e){return!!t.trim(e.code)&&this.hasEffectiveChildForArea(e)},this)},hasEffectiveChildForArea:function(e){var r=e.cities;return!(!r||0===r.length)&&(!!t.trim(e.code)&&_.find(r,function(e){return t.trim(e.code)}))},getDefaultFromAndToDate:function(){return{from:s(this.attributes.from,"/"),to:s(this.attributes.to,"/")}},getAbroadDefaultFrom:function(){return a(new Date,2)},getDefaultToDate:function(e){return s(a(e,this.DEFAULT_INTERVAL),"/")},getToDate:function(e){var t=n(e,"/");return this.getDefaultToDate(t)},createReverseDirections:function(e){var t={};return _.each(e,function(e,r){e.code&&_.each(e.areas,function(e,i){e.code&&_.each(e.cities,function(e){e.code&&!t[e.code]&&(t[e.code]={countryIndex:i,areaIndex:r,portName:e.name})})})}),t},getAirportLabel:function(e){var t=this.get("reverseDirectionsOverseas")[e];if(t)return t.portName},findAreaOrCountry:function(e,t){var r;return _.some(e,function(e){return e.name===t?(r={areaIndex:e.code},!0):_.some(e.areas,function(i){return i.name===t&&(r={areaIndex:e.code,countryIndex:i.code},!0)})}),r},getInputValueToData:function(e,t){var r,i,a=t?this.get("reverseDirectionsOverseas"):this.get("reverseDirections");if(e.length>2&&(r=a[i=e.substring(0,3).toUpperCase()]),r)return{data:r,portCode:i};var s=_.filter(airSuggestList,function(t){return-1!==t.toUpperCase().indexOf(e.toUpperCase())});return 1==s.length?{data:a[i=s[0].substring(0,3)],portCode:i}:void 0},validDate:function(e){if(!e)return!1;try{var t=e.split("/"),r=new Date(t[0],+t[1]-1,t[2]);return null!=r&&r.getFullYear()==t[0]&&r.getMonth()+1==t[1]&&r.getDate()==t[2]}catch(e){return!1}},validateAbroadFromDate:function(e){var t=n(e),r=this.getAbroadDefaultFrom();return t.getTime()>=r.getTime()},validateOneway:function(e,t){var r=[];e.departure||r.push(i(this.errorMessage.required,"出発地"));var a=e.destinations;1===a.length&&a[0]&&!a[0].match(/[^A-Za-z]+/)||r.push(i(this.errorMessage.required,"目的地"));var n=e.fromDate;return n?this.validDate(n)?t&&!this.validateAbroadFromDate(n)&&r.push(i("海外発の最短出発日は{0}です。",s(this.getAbroadDefaultFrom(),"/"))):r.push(i(this.errorMessage.invalidDate,"出発日")):r.push(i(this.errorMessage.required,"出発日")),r},validateRoundtrip:function(e,t){var r=[];e.departure||r.push(i(this.errorMessage.required,"出発地"));var a=e.destinations;1===a.length&&a[0]&&!a[0].match(/[^A-Za-z]+/)||r.push(i(this.errorMessage.required,"目的地")),e.arrival||r.push(i(this.errorMessage.required,"帰国到着地"));var o=!1,u=e.fromDate,c=e.toDates;(u?this.validDate(u)||(r.push(i(this.errorMessage.invalidDate,"出発日")),o=!0):(r.push(i(this.errorMessage.required,"出発日")),o=!0),1===c.length&&c[0]?this.validDate(c[0])||(r.push(i(this.errorMessage.invalidDate,"現地出発日")),o=!0):(r.push(i(this.errorMessage.required,"現地出発日")),o=!0),o)||n(u)>n(c[0])&&(r.push("出発日の指定が不正です。"),o=!0);return o||!t||this.validateAbroadFromDate(e.fromDate)||r.push(i("海外発の最短出発日は{0}です。",s(this.getAbroadDefaultFrom(),"/"))),r},validateStopoverOrOpenjaw:function(e,t,r){var a=[];e.departure||a.push(i(this.errorMessage.required,"出発地"));var n=e.destinations;(n.length<1||_.filter(n,function(e){return!e||e.match(/[^A-Za-z]+/)}).length>0)&&a.push(i(this.errorMessage.required,"目的地")),e.arrival||a.push(i(this.errorMessage.required,"帰国到着地"));var o=e.fromDate,u=e.toDates,c=!1;if(o?this.validDate(o)||(a.push(i(this.errorMessage.invalidDate,"出発日")),c=!0):(a.push(i(this.errorMessage.required,"出発日")),c=!0),_.every(u,function(e,r){return!(!t[r]&&!e)||(c=!0,a.push(i(this.errorMessage.required,"移動日")),!1)},this)&&_.every(u,function(e,r){return!(!t[r]&&!this.validDate(e))||(c=!0,a.push(i(this.errorMessage.invalidDate,"移動日")),!1)},this),!c){var l=_.filter(u,function(e){return!!e});_.reduce(l,function(e,t){return!c&&e>t&&(c=!0,a.push("出発日を確認してください。")),t},o,this)}return c||this.validateAbroadFromDate(e.fromDate)||a.push(i("周遊の最短出発日は{0}です。",s(this.getAbroadDefaultFrom(),"/"))),a},_getTotalNum:function(e,t){var r=t||[],i=_.filter(r,function(e){return e>=2}).length;return[e,i,r.length-i].join(",")},_createGACallback:function(e){var r=t.Deferred(),i=function(){r.resolve()};return setTimeout(i,e||1e3),{callback:i,promise:r.promise()}},sendDataToGoogleAnalytics:function(r){var i=t.Deferred(),a=i.promise();if(!e.ga)return i.resolve(),a;var s=this.googleAnalyticsSetting.categoryPrefix+location.pathname,n=_.reduce(this.googleAnalyticsSetting.target.single,function(e,t){var i;if(null!=(i="totalNum"===t?this._getTotalNum(r.adultNum,r.minorAges):r[t])&&""!==i){var a=this._createGACallback();ga("send","event",s,t,i,{hitCallback:a.callback}),e.push(a.promise)}return e},[],this);return n=_.reduce(this.googleAnalyticsSetting.target.multi,function(e,t){var i=r[t]||[];if(i.length){var a=this._createGACallback();ga("send","event",s,t,i.join(","),{hitCallback:a.callback}),e.push(a.promise)}return e},n,this),t.when.apply(t,n).done(function(){i.resolve()}).fail(function(){i.resolve()}),a},executeSearch:function(e){var i=this;t.ajax(i.getUrl("/air/list_for_cache",e),{type:"GET",cache:!1}).then(function(t){var a={};a="function"==typeof r?_.extend({},e,_.pick(t,"saleSiteCode","order","page","cacheKeyCode"),{serviceWorkerKey:r()}):_.extend({},e,_.pick(t,"saleSiteCode","order","page","cacheKeyCode")),i.set("redirectUrl",i.getUrl("/air/list",a))},function(e){i.set("redirectUrl","/air/error")})},getUrl:function(e,t){return i("{0}?{1}",e,o(t))}});u.AirFormModel=c}(window,jQuery);