!function(e,t){var r=skygate.util.uuid,s=skygate.util.format,a=skygate.util.date.computeDate,i=skygate.util.date.diffDate,n=skygate.util.date.toYmdString,o=(skygate.util.date.ymdStringToObject,skygate.util.date.ymdStringToObjectWithSeparator),u=skygate.util.objectToQueryParameters,c=skygate.air.util,d=airlink.model.common.ui_integration_multi_search_form,h=d.MultiSearchFormBaseModel.extend({ABLE_TO_BUYING_NEXT_DAY_TIME:18,DEFAULT_INTERVAL:3,errorMessage:{required:"{0}を選択してください。",invalidDate:"{0}は存在しない日付です。",invalidPlace:"{0}を正しく入力してください。",samePlace:"出発地とは異なる場所を選択してください。",lastDestinationWithinJapan:"最終目的地は日本国内の空港を入力してください。",inputMore:"{0}を正しく入力してください。",dateInPast:"{0}は今日以降の日付を指定してください。"},googleAnalyticsSetting:{categoryPrefix:"AO_searchpanel_",target:{single:["departure","arrival","fromDate","totalNum","direct","carriers","seatClass","AgentCode","searchKind"],multi:["destinations","toDates","depTimes"]}},defaults:{from:null,to:null,domesticAirports:null,directions:null,directionsOverseas:null,reverseDirections:null,reverseDirectionsOverseas:null},setup:function(t){var r=this.attributes;r.from=t?this.getAbroadDefaultFrom():(new Date).getHours()>=this.ABLE_TO_BUYING_NEXT_DAY_TIME?a(new Date,1):new Date,r.to=a(r.from,this.DEFAULT_INTERVAL),r.domesticAirports=e.domesticAirportList||[],r.directions=e.directions||[],r.directionsOverseas=e.directionsOverSeas||[],r.reverseDirections=this.createReverseDirections(r.directions),r.reverseDirectionsOverseas=this.createReverseDirections(r.directionsOverseas)},hasEffectiveChildForDirection:function(e){var r=e.areas;return!(!r||0===r.length)&&!!_.find(r,function(e){return!!t.trim(e.code)&&this.hasEffectiveChildForArea(e)},this)},hasEffectiveChildForArea:function(e){var r=e.cities;return!(!r||0===r.length)&&(!!t.trim(e.code)&&_.find(r,function(e){return t.trim(e.code)}))},getDefaultFromAndToDate:function(){return{from:n(this.attributes.from,"/"),to:n(this.attributes.to,"/")}},getAbroadDefaultFrom:function(){return a(new Date,2)},getDefaultToDate:function(e){return n(a(e,this.DEFAULT_INTERVAL),"/")},getToDate:function(e){var t=o(e,"/");return this.getDefaultToDate(t)},createReverseDirections:function(e){var t={};return _.each(e,function(e,r){e.code&&_.each(e.areas,function(e,s){e.code&&_.each(e.cities,function(e){e.code&&!t[e.code]&&(t[e.code]={countryIndex:s,areaIndex:r,portName:e.name})})})}),t},getAirportLabel:function(e){var t=this.get("reverseDirectionsOverseas")[e];if(t)return t.portName},findAreaOrCountry:function(e,t){var r;return _.some(e,function(e){return e.name===t?(r={areaIndex:e.code},!0):_.some(e.areas,function(s){return s.name===t&&(r={areaIndex:e.code,countryIndex:s.code},!0)})}),r},getInputValueToData:function(e,t){var r,s,a=t?this.get("reverseDirectionsOverseas"):this.get("reverseDirections");if(e.length>2&&(r=a[s=e.substring(0,3).toUpperCase()]),r)return{data:r,portCode:s};var i=_.filter(airSuggestList,function(t){return-1!==t.toUpperCase().indexOf(e.toUpperCase())});return 1==i.length?{data:a[s=i[0].substring(0,3)],portCode:s}:void 0},validDate:function(e){if(!e)return!1;try{var t=e.split("/"),r=new Date(t[0],+t[1]-1,t[2]);return null!=r&&r.getFullYear()==t[0]&&r.getMonth()+1==t[1]&&r.getDate()==t[2]}catch(e){return!1}},isPastDate:function(e){if(!e)return!1;try{var t=e.split("/"),r=new Date(t[0],+t[1]-1,t[2]),s=a(new Date,0);return!(i(r,s)>=0)}catch(e){return!1}},validateAbroadFromDate:function(e){var t=o(e),r=this.getAbroadDefaultFrom();return t.getTime()>=r.getTime()},validateOneway:function(e,t){var r=[],a=!0;e.departure?(e.departure.match(/[^A-Za-z]+/)||e.departure.length<3||!c.getCityInfo(e.departure))&&(r.push({type:".js-set-city:eq(0)",message:s(this.errorMessage.inputMore,"出発地")}),a=!1):(r.push({type:".js-set-city:eq(0)",message:s(this.errorMessage.required,"出発地")}),a=!1);var i=e.destinations;1===i.length&&i[0]?(i[0].match(/[^A-Za-z]+/)||i[0].length<3||!c.getCityInfo(e.destinations[0]))&&(r.push({type:".js-set-city:eq(1)",message:s(this.errorMessage.inputMore,"目的地")}),a=!1):(r.push({type:".js-set-city:eq(1)",message:s(this.errorMessage.required,"目的地")}),a=!1),a&&e.departure==e.destinations&&r.push({type:".js-set-city:eq(1)",message:this.errorMessage.samePlace});var o=e.fromDate;return o?this.validDate(o)?this.isPastDate(o)?r.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.dateInPast,"出発日")}):t&&!this.validateAbroadFromDate(o)&&r.push({type:".js-date-pick:eq(0)",message:s("海外発の最短出発日は{0}です。",n(this.getAbroadDefaultFrom(),"/"))}):r.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.invalidDate,"出発日")}):r.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.required,"出発日")}),r},validateRoundtrip:function(e,t){var r=[],a=!0;e.departure?(e.departure.match(/[^A-Za-z]+/)||e.departure.length<3||!c.getCityInfo(e.departure))&&(r.push({type:".js-set-city:eq(0)",message:s(this.errorMessage.inputMore,"出発地")}),a=!1):(r.push({type:".js-set-city:eq(0)",message:s(this.errorMessage.required,"出発地")}),a=!1);var i=e.destinations;1===i.length&&i[0]?(i[0].match(/[^A-Za-z]+/)||i[0].length<3||!c.getCityInfo(i[0]))&&(r.push({type:".js-set-city:eq(1)",message:s(this.errorMessage.inputMore,"目的地")}),a=!1):(r.push({type:".js-set-city:eq(1)",message:s(this.errorMessage.required,"目的地")}),a=!1),a&&e.departure==e.destinations[0]&&r.push({type:".js-set-city:eq(1)",message:this.errorMessage.samePlace});var u=!1,d=e.fromDate,h=e.toDates;(d?this.validDate(d)?this.isPastDate(d)&&(r.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.dateInPast,"出発日")}),u=!0):(r.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.invalidDate,"出発日")}),u=!0):(r.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.required,"出発日")}),u=!0),1===h.length&&h[0]?this.validDate(h[0])?this.isPastDate(h[0])&&(r.push({type:".js-date-pick:eq(1)",message:s(this.errorMessage.dateInPast,"現地出発日")}),u=!0):(r.push({type:".js-date-pick:eq(1)",message:s(this.errorMessage.invalidDate,"現地出発日")}),u=!0):(r.push({type:".js-date-pick:eq(1)",message:s(this.errorMessage.required,"現地出発日")}),u=!0),u)||o(d)>o(h[0])&&(r.push({type:".js-date-pick:eq(0)",message:"出発日の指定が不正です。"}),u=!0);return u||!t||this.validateAbroadFromDate(e.fromDate)||r.push({type:".js-date-pick:eq(0)",message:s("海外発の最短出発日は{0}です。",n(this.getAbroadDefaultFrom(),"/"))}),r},validateStopoverOrOpenjaw:function(e,t,r,a,i){var o=[],u=_.map(a,function(e){return this._validatePlace(e)},this),c=_.map(_.range(0,_.size(i)),function(e){var t=this._validatePlace(i[e]);return t.isValid&&u[e].isValid&&i[e]==a[e]&&(t.isValid=!1,t.message=this.errorMessage.samePlace),t},this),d=0;_.each(u,function(e){e.isValid||o.push({type:s(".js-set-city:eq({0})",2*d),message:s(e.message,"出発地")}),d+=1},this);d=0;_.each(c,function(e){e.isValid||o.push({type:s(".js-set-city:eq({0})",2*d+1),message:s(e.message,"目的地")}),d+=1},this);var h=e.fromDate,l=!1;h?this.validDate(h)?this.isPastDate(h)&&(o.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.dateInPast,"出発日")}),l=!0):(o.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.invalidDate,"出発日")}),l=!0):(o.push({type:".js-date-pick:eq(0)",message:s(this.errorMessage.required,"出発日")}),l=!0);var g=e.toDates,p=(d=1,_.map(g,function(e,r){var a=!1;return t[r]||(e||(l=!0,o.push({type:s(".js-date-pick:eq({0})",d),message:s(this.errorMessage.required,"出発日")}),a=!0),d+=1),a},this));d=1;if(p&&_.each(g,function(e,r){t[r]||p[r]||(this.validDate(e)?this.isPastDate(e)&&(l=!0,o.push({type:s(".js-date-pick:eq({0})",d),message:s(this.errorMessage.dateInPast,"出発日")})):(l=!0,o.push({type:s(".js-date-pick:eq({0})",d),message:s(this.errorMessage.invalidDate,"出発日")})),d+=1)},this),!l){var m=_.filter(g,function(e){return!!e});_.reduce(m,function(e,t,r){return t?(!l&&e>t&&(l=!0,o.push({type:s(".js-date-pick:eq({0})",r+1),message:"出発日を確認してください。"})),t):e},h,this)}return l||this.validateAbroadFromDate(e.fromDate)||o.push({type:".js-date-pick:eq(0)",message:s("周遊の最短出発日は{0}です。",n(this.getAbroadDefaultFrom(),"/"))}),o},_getTotalNum:function(e,t){var r=t||[],s=_.filter(r,function(e){return e>=2}).length;return[e,s,r.length-s].join(",")},_createGACallback:function(e){var r=t.Deferred(),s=function(){r.resolve()};return setTimeout(s,e||1e3),{callback:s,promise:r.promise()}},sendDataToGoogleAnalytics:function(r){var s=t.Deferred(),a=s.promise();if(!e.ga)return s.resolve(),a;var i=this.googleAnalyticsSetting.categoryPrefix+location.pathname,n=_.reduce(this.googleAnalyticsSetting.target.single,function(e,t){var s;if(null!=(s="totalNum"===t?this._getTotalNum(r.adultNum,r.minorAges):r[t])&&""!==s){var a=this._createGACallback();ga("send","event",i,t,s,{hitCallback:a.callback}),e.push(a.promise)}return e},[],this);return n=_.reduce(this.googleAnalyticsSetting.target.multi,function(e,t){var s=r[t]||[];if(s.length){var a=this._createGACallback();ga("send","event",i,t,s.join(","),{hitCallback:a.callback}),e.push(a.promise)}return e},n,this),t.when.apply(t,n).done(function(){s.resolve()}).fail(function(){s.resolve()}),a},executeSearch:function(e){var s=this;t.ajax(s.getUrl("/air/list_for_cache",e),{type:"GET",cache:!1}).then(function(t){var a={};a="function"==typeof r?_.extend({},e,_.pick(t,"saleSiteCode","order","page","cacheKeyCode"),{serviceWorkerKey:r()}):_.extend({},e,_.pick(t,"saleSiteCode","order","page","cacheKeyCode")),s.set("redirectUrl",s.getUrl("/air/list",a))},function(e){s.set("redirectUrl","/air/error")})},getUrl:function(e,t){return s("{0}?{1}",e,u(t))},getPortCodeFromText:function(e){var t;return e.length>4&&(t=e.substring(1,4).toUpperCase()),t},_validatePlace:function(e){var t="",r=!0;return e?(e.match(/[^A-Za-z]+/)||e.length<3||!c.getCityInfo(e))&&(t=this.errorMessage.inputMore,r=!1):(t=this.errorMessage.required,r=!1),{isValid:r,message:t}}});d.AirFormModel=h}(window,jQuery);