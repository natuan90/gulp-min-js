!function(t,e){var a=e(document),i=(airlink.msf,skygate.util.format),s=skygate.util.date.toYmdString,l=skygate.util.date.toYmdStringWithDayOfTheWeek,r=skygate.util.date.toYmString,n=(skygate.util.date.ymdStringToObject,skygate.util.date.ymdStringToObjectWithSeparator),o=skygate.util.date.diffDate,h=skygate.util.date.formatDayOfTheWeek,d=skygate.util.date.computeDate,c=(h=function(t){return l(n(t),"/")},airlink.view.sp.multi_search_form.AirFormModalBaseView),u=Backbone.Model.extend({ABLE_TO_BUYING_NEXT_DAY_TIME:18,DEFAULT_INTERVAL:3,CALENDAR_LIMIT:360,initialize:function(){this.defaultFromDate=this.getDefaultFromDate(this.ABLE_TO_BUYING_NEXT_DAY_TIME),this.from=new Date(this.defaultFromDate.getFullYear(),this.defaultFromDate.getMonth(),this.defaultFromDate.getDate()),this.limit=d(new Date,this.CALENDAR_LIMIT)},getDefaultFromDate:function(t){return(new Date).getHours()>=t?d(new Date,1):new Date},_checkHoliday:function(t){return!!ktHolidayName(t)},_createDate:function(t,e){return{exist:!0,disable:e,saturday:6===t.getDay(),holiday:0===t.getDay()||this._checkHoliday(t),label:t.getDate(),ymd:s(t,"/")}},_setupEmptyDate:function(t,e){_.times(e,function(){t.push({exist:!1})})},_createMonth:function(t,e){var a=this._getMonthEndDate(t),i={year:t.getFullYear(),month:t.getMonth()+1},s=[],l=[];this._setupEmptyDate(l,t.getDay());for(var r=t;a>=r;){l.push(this._createDate(r,this.from>r||r>this.limit));var n=6===r.getDay();n?(s.push(l),l=[]):a.getTime()!=r.getTime()||n||(this._setupEmptyDate(l,7-(r.getDay()+1)),s.push(l)),0!==(r=d(r,1)).getHours()&&r.setTime(r.getTime()+36e5)}return i.weeks=s,i},getCalendarMonths:function(){for(var t=[],e=new Date(this.from.getFullYear(),this.from.getMonth(),1),a=r(e),i=r(this.limit);i>=a;)t.push(this._createMonth(e,i===a)),e=this._getNextMonth(e),a=r(e);return t},_getMonthEndDate:function(t){return new Date(t.getFullYear(),t.getMonth()+1,0)},_getNextMonth:function(t){return new Date(t.getFullYear(),t.getMonth()+1,1)}}),m=c.extend({el:".modal-calendar",templateId:"#calendarTemplate",dateLabelFormat:'<span class="date">{0}<strong class="time">{1}</strong></span>',dateSelectindElement:'<li>現地出発日<span class="date"><strong class="time">日程を選択</strong></span></li>',activateStartClass:"cl-dep-date",activateInClass:"cl-travel-period",activateEndClass:"cl-rtn-date",events:{"click .selectable":"select","click .btn-conversion-01":"decide","click .box-btn-close-01":"close"},initialize:function(){_.bindAll(this),this.clickCount=0,this.$wrapperCalendar=this.$(".wrapper-calendar"),this.$fromCalendarTitle=this.$(".fromCalendarTitle"),this.$toCalendarTitle=this.$(".toCalendarTitle"),this.$dateBox=this.$(".date-box-01"),this.template=_.template(e(this.templateId).html()),this.model=new u,this.createCalendar(),a.on("showOnewayOrRoundtripCalendar",this.showOnewayOrRoundtripCalendar),a.on("showStopoverCalendar",this.showStopoverCalendar),a.on("hideCalendar",this.hideCalendar)},showOnewayOrRoundtripCalendar:function(t,a){this.originalTop=a.top,this.originalFrom=a.from,this.originalTo=a.to,this.isSingleSelect=!a.to,this.hideTargetSelector=a.hideTargetSelector,this._clearActivate();var i=n(a.from);this.$fromCalendarTitle.data("from",a.from),this.$fromCalendarTitle.html(this._getDateLabel(l(i,"/")));var s=this.$('.selectable[data-value="'+a.from+'"]');if(this.isSingleSelect)this.clickCount=1,this.$wrapperCalendar.removeClass("round-trip"),this._activateCalendarDate(s,0);else{this.clickCount=2;var r=n(a.to);this.$toCalendarTitle.data("to",a.to),this.$toCalendarTitle.html(this._getDateLabel(l(r,"/"),!0)),this.$wrapperCalendar.addClass("round-trip"),this._activateCalendarDate(s,-1*o(i,r))}this._show(this.$el),this._hide(e(this.hideTargetSelector));var h=this;_.defer(function(){var t=h.$(".fixed-area-01").height()+4;skygate.util.moveTo(s.parents(".date-group").get(0),-t)})},showStopoverCalendar:function(t,a){this.originalTop=a.top,this.originalBefore=a.before,this.originalFrom=a.from,this.isSingleSelect=!0,this.isStopover=!0,this.currentDateIndex=a.index,this.hideTargetSelector=a.hideTargetSelector,this._clearActivate();var i=n(a.from);this.$fromCalendarTitle.data("from",a.from),this.$fromCalendarTitle.html(this._getDateLabel(l(i,"/")));var s=this.$('.selectable[data-value="'+a.from+'"]');this.clickCount=1,this.$wrapperCalendar.removeClass("round-trip"),this._activateCalendarDate(s,0),a.before&&this._unselectableCalendarDate(a.before),this._show(this.$el),this._hide(e(this.hideTargetSelector));var r=this;_.defer(function(){var t=r.$(".fixed-area-01").height()+4;skygate.util.moveTo(s.parents(".date-group").get(0),-t)})},createCalendar:function(){var t=this.model.getCalendarMonths(),e=this.template({months:t});this.$dateBox.html(e)},decide:function(t){var e={from:this.$fromCalendarTitle.data("from")};if(this.isSingleSelect)e.index=this.currentDateIndex;else{if(1===this.clickCount)return;e.to=this.$toCalendarTitle.data("to")}a.trigger("closeCalendar",e),this.close()},hideCalendar:function(a){this.$el.is(":visible")&&(this.$(".selectable").removeClass("unselectable"),this._show(e(this.hideTargetSelector)),this._hide(this.$el),t.scrollTo(0,this.originalTop||0))},_activateCalendarDate:function(t,a){if(t.addClass(this.activateStartClass),0!==a){var i,s=this.$(".selectable"),l=s.index(t.get(0));_.times(a,function(){l++;var t=e(s.get(l));t.addClass(this.activateInClass),i=t},this),i.removeClass(this.activateInClass).addClass(this.activateEndClass)}else t.addClass(this.activateEndClass)},_getDateLabel:function(t,e){return i((e?"現地出発日":"出発日")+this.dateLabelFormat,t.substring(0,5),t.substring(5,t.length))},_unselectableCalendarDate:function(t){var a=this.$(".selectable"),i=e(a.get(0)),s=o(n(i.data("value")),n(t));if(0!==s){i.addClass("unselectable");var l=0;_.times(-1*s-1,function(){l++,(i=e(a.get(l))).addClass("unselectable")})}},_clearActivate:function(){this.$dateBox.find("."+this.activateStartClass).removeClass(this.activateStartClass),this.$dateBox.find("."+this.activateInClass).removeClass(this.activateInClass),this.$dateBox.find("."+this.activateEndClass).removeClass(this.activateEndClass)},select:function(t){e(t.currentTarget).hasClass("unselectable")||(this.isSingleSelect?this._selectSingle(t):this._selectMultiple(t))},_selectSingle:function(t){this.clickCount+=1,2===this.clickCount&&(this.clickCount=1,this._clearActivate());var a=e(t.currentTarget),i=a.data("value");this.$fromCalendarTitle.data("from",i),this.$fromCalendarTitle.html(this._getDateLabel(h(i))),a.addClass(this.activateStartClass),a.addClass(this.activateEndClass)},_selectMultiple:function(t){this.clickCount+=1,3===this.clickCount&&(this.clickCount=1,this._clearActivate(),this.$toCalendarTitle.html(this.dateSelectindElement));var a=e(t.currentTarget),i=a.data("value");if(1===this.clickCount)this.$fromCalendarTitle.data("from",i),this.$fromCalendarTitle.html(this._getDateLabel(h(i))),a.addClass(this.activateStartClass);else{var s=this.$fromCalendarTitle.data("from");if(s!==i){var l,r=n(s),d=n(i),c=o(r,d);c<0?(l=this.$('.selectable[data-value="'+s+'"]'),c*=-1,this.$toCalendarTitle.data("to",i),this.$toCalendarTitle.html(this._getDateLabel(h(i),!0))):(this.$('.selectable[data-value="'+s+'"]').removeClass(this.activateStartClass),l=this.$('.selectable[data-value="'+i+'"]'),this.$fromCalendarTitle.data("from",i),this.$fromCalendarTitle.html(this._getDateLabel(h(i))),this.$toCalendarTitle.data("to",s),this.$toCalendarTitle.html(this._getDateLabel(h(s),!0))),this._activateCalendarDate(l,c)}else this.$toCalendarTitle.data("to",i),this.$toCalendarTitle.html(this._getDateLabel(h(i),!0)),a.addClass(this.activateEndClass)}}});skygate.util.namespace("airlink.view.sp.multi_search_form").CalendarView=m}(window,jQuery);