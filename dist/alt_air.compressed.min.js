!function(e,t){var i=t(document),r=skygate.util.format,s=skygate.util.date.computeDate,a=skygate.util.date.toYmdString,n=skygate.util.date.toYmdStringWithDayOfTheWeek,o=skygate.util.date.ymdStringToObject,d=skygate.util.date.ymdStringToObjectWithSeparator,h=skygate.util.date.diffDate,l=airlink.model.common.multi_search_form.AirFormModel,c={routes:{"showSingleDestinationModal/:top/:type":"triggerShowSingleDestinationModal","showMultiStageDestinationModal/:top/:origin":"triggerShowMultiStageDestinationModal","showPassengerModal/:top":"triggerShowPasengerModal","showRoundtripCalendar/:top/:hideTargetSelector/:from/:to":"triggerShowRoundtripCalendar","showOnewayCalendar/:top/:hideTargetSelector/:from":"triggerShowOnewayCalendar","showStopoverCalendar/:top/:hideTargetSelector/:index/:from/:before":"triggerShowStopoverCalendar","showStopoverCalendar/:top/:hideTargetSelector/:index/:from":"triggerShowStopoverCalendar","*default":"hideAirFormModals"},routesToBeReset:{showSingleDestinationModal:1,showMultiStageDestinationModal:1,showPassengerModal:1,showRoundtripCalendar:1,showOnewayCalendar:1,showStopoverCalendar:1},initialize:function(){_.bindAll(this),_.any(_.keys(this.routesToBeReset),function(e){return 1===location.hash.indexOf(e)})&&(location.hash="")},triggerShowSingleDestinationModal:function(e,t){i.trigger("showSingleDestinationModal",{top:+e,type:t})},triggerShowMultiStageDestinationModal:function(e,t){var r={top:+e};if(_.isNaN(+t)){if("departure"!==t&&"arrival"!==t&&"stopoverArrival"!==t)return;r.type=t}else r.index=+t;i.trigger("showMultiStageDestinationModal",r)},triggerShowPasengerModal:function(e){i.trigger("showPassengerModal",{top:+e})},triggerShowRoundtripCalendar:function(e,t,r,s){i.trigger("showOnewayOrRoundtripCalendar",{top:+e,hideTargetSelector:t,from:r,to:s})},triggerShowOnewayCalendar:function(e,t,r){i.trigger("showOnewayOrRoundtripCalendar",{top:+e,hideTargetSelector:t,from:r})},triggerShowStopoverCalendar:function(e,t,r,s,a){i.trigger("showStopoverCalendar",{top:+e,hideTargetSelector:t,index:+r,from:s,before:a})},hideAirFormModals:function(){i.trigger("hideCalendar"),i.trigger("hideSingleDestinationModal"),i.trigger("hideMultiStageDestinationModal"),i.trigger("hidePassengerModal")}},u=Backbone.Router.extend(c),p=Backbone.View.extend({hide:function(i){this.$el.is(":visible")&&(this._show(t(this.hideTargetSelector)),this._hide(this.$el),e.scrollTo(0,this.originalTop||0))},close:function(e){history.back()},_show:function(e){e.removeClass("none")},_hide:function(e){e.addClass("none")}}),m=p.extend({el:".modal-number",btnDisabledClass:"btn-disabled",events:{"click .btn-conversion-01":"decide","click .box-btn-close-01":"close","click .incrementAdult":"incrementAdult","click .decrementAdult":"decrementAdult","click .incrementChild":"incrementChild","click .decrementChild":"decrementChild"},initialize:function(e){if(!e||!e.airFormModel)throw new Error("airFormModel is required");this.model=e.airFormModel,_.bindAll(this),this.$adultBox=this.$(".adultBox"),this.$adultIncrementBtn=this.$adultBox.find(".incrementAdult"),this.$adultDecrementBtn=this.$adultBox.find(".decrementAdult"),this.$childBox=this.$(".childBox"),this.$childIncrementBtn=this.$childBox.find(".incrementChild"),this.$childDecrementBtn=this.$childBox.find(".decrementChild"),this.$childAgeWrapper=this.$(".wrapper-child-detail"),this.$childAgeBoxes=this.$(".childAgeBox"),i.on("hidePassengerModal",this.hide)},show:function(i){this.originalTop=i.top,this.hideTargetSelector=i.hideTargetSelector;var r=i.adultNum,s=i.minorAges;_.each(s,function(e,i){t(this.$("select").get(i)).val(e)},this),this._setChildNum(s.length),this._adjustAdultBtnState(r),this._adjustChild(r),this._setAdultNum(r),this._show(this.$el),this._hide(t(this.hideTargetSelector)),_.defer(function(){e.scrollTo(0,0)})},incrementAdult:function(e){if(!this.$adultIncrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentAdultNum()+1;this._adjustAdultBtnState(t),this._adjustChild(t),this._setAdultNum(t)}},decrementAdult:function(e){if(!this.$adultDecrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentAdultNum()-1;this._adjustAdultBtnState(t),this._adjustChild(t),this._setAdultNum(t)}},_adjustAdultBtnState:function(e){9===e?(this.$adultIncrementBtn.addClass(this.btnDisabledClass),this.$adultDecrementBtn.removeClass(this.btnDisabledClass)):1===e?(this.$adultIncrementBtn.removeClass(this.btnDisabledClass),this.$adultDecrementBtn.addClass(this.btnDisabledClass)):(this.$adultIncrementBtn.removeClass(this.btnDisabledClass),this.$adultDecrementBtn.removeClass(this.btnDisabledClass))},incrementChild:function(e){if(!this.$childIncrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentChildNum()+1,i=this._getCurrentAdultNum();4!==t&&t!==this._getCurrentAdultNum()&&i+t!==9||this.$childIncrementBtn.addClass(this.btnDisabledClass),this.$childDecrementBtn.removeClass(this.btnDisabledClass),this._setChildNum(t)}},decrementChild:function(e){if(!this.$childDecrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentChildNum()-1;this.$childIncrementBtn.removeClass(this.btnDisabledClass),0===t&&this.$childDecrementBtn.addClass(this.btnDisabledClass),this._setChildNum(t)}},_adjustChild:function(e){var t=this._getCurrentChildNum(),i=e+t,r=t;9===i?this.$childIncrementBtn.addClass(this.btnDisabledClass):9<i?(this.$childIncrementBtn.addClass(this.btnDisabledClass),r=t-1,this._setChildNum(r)):t===e?this.$childIncrementBtn.addClass(this.btnDisabledClass):e<t?(this.$childIncrementBtn.addClass(this.btnDisabledClass),r=t-1,this._setChildNum(r)):this.$childIncrementBtn.removeClass(this.btnDisabledClass),0===r?this.$childDecrementBtn.addClass(this.btnDisabledClass):this.$childDecrementBtn.removeClass(this.btnDisabledClass)},_getCurrentAdultNum:function(){return+this.$adultBox.find(".num-count-txt-01").text()},_getCurrentChildNum:function(){return+this.$childBox.find(".num-count-txt-01").text()},_setAdultNum:function(e){return this.$adultBox.find(".num-count-txt-01").text(e)},_setChildNum:function(e){return 0===e?this.$childAgeWrapper.addClass("none"):(this.$childAgeWrapper.removeClass("none"),_.each(this.$childAgeBoxes,function(i,r){var s=t(i);r<e?s.removeClass("none"):s.addClass("none")})),+this.$childBox.find(".num-count-txt-01").text(e)},decide:function(e){var r=this._getCurrentAdultNum(),s=_.map(_.filter(this.$("select"),function(e){return t(e).is(":visible")}),function(e){return+t(e).val()});i.trigger("selectPassenger",{adultNum:r,minorAges:s}),this.close()}}),g=p.extend({el:".modal-select-point-01",domesticAirportFormat:'<li><a href="javascript:void(0);" class="domesticAirport" data-value="{0}">{1}</a></li>',headerText:{departure:"出発地を選択",arrival:"帰国到着地を選択"},events:{"click .domesticAirport":"select","click .box-btn-close-01":"close"},initialize:function(e){if(!e||!e.airFormModel)throw new Error("airFormModel is required");this.model=e.airFormModel,_.bindAll(this),i.on("hideSingleDestinationModal",this.hide),this._renderContent()},show:function(i){this.originalTop=i.top,this.hideTargetSelector=i.hideTargetSelector,this.type=i.type,this.currentCode=i.code,this.$(".hdg-search-01").text(this.headerText[this.type]),this._show(this.$el),this._hide(t(this.hideTargetSelector));var r=this;_.defer(function(){var t=r.$("a[data-value="+r.currentCode+"]");r.currentCode&&t.length?skygate.util.moveTo(t.get(0),0):e.scrollTo(0,0)})},_renderContent:function(){var e=_.reduce(this.model.get("domesticAirports"),function(e,t){return e+r(this.domesticAirportFormat,t.code,t.label)},"",this);this.$(".list-search-01").html(e)},select:function(e){var r=t(e.currentTarget).data("value");r&&(i.trigger("selectSingleDestination",{type:this.type,code:r}),this.close())}}),v=p.extend({el:".modal-select-point-02",areaFormat:'<li><a href="javascript: void(0);" class="selectArea" data-areaIndex="{0}">{1}</a></li>',countryFormat:'<li><a href="javascript: void(0);" class="selectCountry" data-countryIndex="{0}">{1}</a></li>',portFormat:'<li><a href="javascript: void(0);" class="selectPort" data-portCode="{0}">{1}</a></li>',breadcrumbAreaFormat:'<a href="javascript: void(0);">{0}</a>',headerText:{departure:"出発地を選択",arrival:"帰国到着地を選択",stopoverArrival:"到着地を選択",destination:"目的地を選択",area:"まずはエリアを選択してください",country:"次に国を選択してください",port:"都市を選択してください"},events:{"click .selectArea":"selectArea","click .selectCountry":"selectCountry","click .selectPort":"selectPort","click .js-prev-area":"toArea","click .js-prev-country":"toCountry","click .box-btn-close-01":"close"},initialize:function(e){if(!e||!e.airFormModel)throw new Error("airFormModel is required");this.model=e.airFormModel,_.bindAll(this),this.$areaWrapper=this.$(".wrapper-select-area"),this.$countryWrapper=this.$(".wrapper-select-country"),this.$portWrapper=this.$(".wrapper-select-city"),this.$backToAreaLink=this.$(".box-btn-prev").find(".js-prev-area"),this.$backToCountryLink=this.$(".box-btn-prev").find(".js-prev-country"),i.on("hideMultiStageDestinationModal",this.hide)},_renderArea:function(){var e=_.reduce(this._getDirections(),function(e,t){var i=this.model.hasEffectiveChildForDirection(t)?t.code:-1;return e+r(this.areaFormat,i,t.name)},"",this);this.$(".js-area-select").html(e)},_renderCountry:function(e){var t;this._countries||(this._countries={}),this._countries[e]?t=this._countries[e]:(t=_.reduce(this._getDirections()[e].areas,function(e,t){var i=this.model.hasEffectiveChildForArea(t)?t.code:-1;return e+r(this.countryFormat,i,t.name)},"",this),this._countries[e]=t),this.$(".js-country-select").html(t)},_renderPorts:function(e,t){this._ports||(this._ports={});var i=e+"_"+t;if(!this._ports[i]){var s=_.reduce(this._getDirections()[e].areas[t].cities,function(e,t){return e+r(this.portFormat,t.code,t.name)},"",this);this._ports[i]=s}this.$(".js-port-select").html(this._ports[i])},_renderBreadcrumb:function(e,t){var i=this.$(".box-selectpoint"),s=i.find(".point-01"),a=i.find(".point-02");e&&t?(i.removeClass("none"),s.html(r(this.breadcrumbAreaFormat,e)).removeClass("none"),a.text(t).removeClass("none")):e?(i.removeClass("none"),s.html(e).removeClass("none"),a.addClass("none").text("")):(i.addClass("none"),s.addClass("none"))},selectArea:function(e){var i=t(e.currentTarget),r=i.data("areaindex");-1!==r&&(i.addClass("selected"),this._renderCountry(r),this.toCountry())},selectCountry:function(e){var i=t(e.currentTarget),r=i.data("countryindex");if(-1!==r){var s=this._getSelectedAreaInfo();s&&(i.addClass("selected"),this._renderPorts(s.areaIndex,r),this.toPort())}},selectPort:function(e){var r=t(e.currentTarget).data("portcode");r&&(i.trigger("selectMultiStageDestination",{type:this.type,index:this.index,code:r}),this.close())},toArea:function(e){_.defer(this._toArea)},toCountry:function(e){_.defer(this._toCountry)},toPort:function(e){_.defer(this._toPort)},_toArea:function(){this.$areaWrapper.removeClass("prev"),this.$areaWrapper.addClass("select"),this.$countryWrapper.removeClass("select"),this.$countryWrapper.removeClass("prev"),this.$portWrapper.removeClass("select"),this.$(".selectArea").removeClass("selected"),this.$(".selectCountry").removeClass("selected"),this.$backToAreaLink.addClass("none"),this.$backToCountryLink.addClass("none"),this._renderBreadcrumb(),this._updateModalHeaderText(this.headerText.area),this._toTargetPosition()},_toCountry:function(){this.$areaWrapper.removeClass("select"),this.$areaWrapper.addClass("prev"),this.$countryWrapper.removeClass("prev"),this.$countryWrapper.addClass("select"),this.$portWrapper.removeClass("select"),this.$backToAreaLink.removeClass("none"),this.$backToCountryLink.addClass("none"),this.$(".selectCountry").removeClass("selected"),this._renderBreadcrumb(this._getSelectedAreaInfo().name),this._updateModalHeaderText(this.headerText.country),this._toTargetPosition()},_toPort:function(){this.$countryWrapper.removeClass("select"),this.$countryWrapper.addClass("prev"),this.$portWrapper.addClass("select"),this.$backToAreaLink.addClass("none"),this.$backToCountryLink.removeClass("none"),this._renderBreadcrumb(this._getSelectedAreaInfo().name,this._getSelectedCountryInfo().name),this._updateModalHeaderText(this.headerText.port),this._toTargetPosition()},_getSelectedAreaInfo:function(){var e=t(_.find(this.$(".selectArea"),function(e){return t(e).hasClass("selected")})),i=e.data("areaindex");if(e.length&&-1!==i)return{areaIndex:i,name:e.text()}},_getSelectedCountryInfo:function(){var e=t(_.find(this.$(".selectCountry"),function(e){return t(e).hasClass("selected")})),i=e.data("countryindex");if(e.length&&-1!==i)return{countryIndex:i,name:e.text()}},_updateModalHeaderText:function(e){this.$(".box-search-hdg-01").find(".hdg-search-02").text(e)},_getDirections:function(){return this.isOverseas?this.model.get("directionsOverseas"):this.model.get("directions")},_getReverseDirections:function(){return this.isOverseas?this.model.get("reverseDirectionsOverseas"):this.model.get("reverseDirections")},show:function(e){this.originalTop=e.top,this.hideTargetSelector=e.hideTargetSelector,this.type=e.type,this.index=e.index,this.currentCode=e.code,this.isOverseas=e.isOverseas;var i=this.headerText[this.type]||this.headerText.destination;this.$(".hdg-search-01").text(i),this._restoreState(),this._show(this.$el),this._hide(t(this.hideTargetSelector))},_restoreAreaState:function(e,i,r){var s=t(_.find(this.$(".selectArea"),function(i){return t(i).data("areaindex")==e}));s.length&&(s.click(),null!=i&&_.defer(this._restoreCountryState,i,r))},_restoreCountryState:function(e,i){var r=t(_.find(this.$(".selectCountry"),function(i){return t(i).data("countryindex")==e}));if(r.length&&(r.click(),i)){var s=t(_.find(this.$(".selectPort"),function(e){return t(e).data("portcode")==i}));s.length&&_.defer(this._toTargetPosition,s.get(0))}},_restoreState:function(){var e,t,i;if(this._renderArea(),this.currentCode){var r=this._getReverseDirections()[this.currentCode];if(r)e=r.areaIndex,t=r.countryIndex,i=this.currentCode;else{var s=this.model.findAreaOrCountry(this._getDirections(),this.currentCode);s&&(e=s.areaIndex,t=s.countryIndex)}}null==e&&null==t?(this._toArea(),this._toTargetPosition()):this._restoreAreaState(e,t,i)},_toTargetPosition:function(t){var i=this;_.defer(function(){if(t){var r=i.$(".fixed-area-01").height();skygate.util.moveTo(t,-r)}else e.scrollTo(0,0)})}}),f={ROUNDTRIP:0,ONEWAY:2,STOPOVER:4,OPENJAW:3},D=Backbone.View.extend({el:".airFormContainer",currentSearchKind:f.ROUNDTRIP,isDepartureTypeDomestic:!0,dateLabelFormat:'{0}<strong class="time">{1}</strong>',hideTargetSelectors:"#article-content, #searchFormModal, [data-role=content], [data-role=searchForm]",events:{"click .btn-conversion-01":"searchAir","click .searchKind":"changeSearchKind","click .item-number-01":"navigatePassengerModal","click .showSingleDestinationModal":"navigateSingleDestinationModal","click .showMultiStageDestinationModal":"navigateMultiStageDestinationModal","click .showCalendar":"showCalendar","click .link-delete-01":"hideDestination","click .btn-add-01":"showNextDestination","change .isOpenjaw":"toggleOpenjaw","click .toggle-search-trigger":"showOrHideOptionalCondition"},initialize:function(e){_.bindAll(this),this.isDepartureTypeDomestic=!e||!e.isDepartureTypeAbroad,this.isResearch=e&&e.isResearch,this.sendGA=!1,this.model=new l,this.model.setup(!this.isDepartureTypeDomestic);var t=this.model.getDefaultFromAndToDate();this._initializeDates(t),this._clearParameter(),this.passengerModalView=new m({airFormModel:this.model}),this.isDepartureTypeDomestic&&(this.singleDestinationModalView=new g({airFormModel:this.model})),this.multiStageDestinationModalView=new v({airFormModel:this.model}),i.on("showPassengerModal",this.callPassengerModal),i.on("selectPassenger",this.selectPassenger),i.on("showSingleDestinationModal",this.callSingleDestinationModal),i.on("selectSingleDestination",this.selectSingleDestination),i.on("showMultiStageDestinationModal",this.callMultiStageDestinationModal),i.on("selectMultiStageDestination",this.selectMultiStageDestination),i.on("closeCalendar",this.closeCalendar);var r=this.getInitialParameter();r&&(r.sendGA&&(this.sendGA=!0),r=this._convertInitialParameter(r));var s=(this.isResearch?this._convertQuery(this.$el.data("query")):this.model.getSavedCondition(this.getContainerId()))||r;if(s){var a=this;_.defer(function(){a.restoreCondition(s)})}this.$el.on("SetAirDeparture",this.setDeparture),this.$el.on("SetAirDestination",this.setDestination),this.$el.on("SetAirFromDate",this.setFromDate),this.$el.on("SetAirToDate",this.setToDate),this.listenTo(this.model,"change:redirectUrl",this.moveToPage)},restoreCondition:function(e){e.AgentCode&&this.$("input[name=AgentCode]").val(e.AgentCode),this.isResearch&&e.order&&(this._order=e.order);var i=e.searchKind;if(i===f.OPENJAW&&(i=f.STOPOVER),null!=i&&(this.$(r(".searchKind[value={0}]",i)).prop("checked",!0),this._changeSearchKind(i)),e.fromDate&&this._setupFromDate(e.fromDate),this._setupToDates(e.fromDate||this.model.getDefaultFromAndToDate().from,e.toDates),e.departure&&(this._setupDeparture(e.departure),e.arrival||this._setupArrival(e.departure)),e.destinations&&e.destinations.length){var s=this.$(".onewayOrRoundtripDestination"),a=this.$(".stopoverDestination");_.each(e.destinations,function(e,i){0===i&&this._setupDestination(s,e);var r=t(a.get(i));this._setupDestination(r,e),1<i&&this._showDestination()},this)}e.adultNum&&this._setupAdult(+e.adultNum),this._setupMinorAges(e.minorAges||[]),e.arrival&&this._setupArrival(e.arrival);var n=!1;if(this._isOnewayOrRoundtrip()&&(n=this._getDeparturePort()!==this._getArrivalPort()),e.direct&&(this.$(".direct").prop("checked",!0),n=!0),e.openFix&&(this.$(".openFix").prop("checked",!0),n=!0),e.seatClass&&(this.$("#seat-cls").val(e.seatClass),n=!0),e.omitLcc&&(this.$(".omitLcc").prop("checked",!0),n=!0),e.carriers&&(this.$("#carrier-select").val(e.carriers),n=!0),e.depTimes){var o=_.sortBy(this.$(".depTimes"),function(e){return e.value});o.length&&(_.each(e.depTimes,function(e){t(o[+e-1]).click()}),n=!0)}n&&!this.$(".toggle-search-trigger").hasClass("active")&&this.$(".toggle-search-trigger").addClass("active")},_convertQuery:function(e){var t=e.fromDate;t&&-1===t.indexOf("/")&&(e.fromDate=a(o(t),"/"));var i=e.toDates;return i&&0<i.length&&(e.toDates=_.map(i,function(e){return e&&-1===e.indexOf("/")?a(o(e),"/"):e})),e},_convertInitialParameter:function(e){var i=t.extend({},!0,e),r=e.searchKind;i.searchKind=r?f[r.toUpperCase()]:f.ROUNDTRIP;var n=e.fromDate;n&&_.isString(n)&&-1===n.indexOf("/")?i.fromDate=a(o(n),"/"):n&&_.isNumber(n)&&(i.fromDate=a(s(this.model.get("from"),n),"/"));var h=e.toDates,l=i.fromDate?d(i.fromDate,"/"):this.model.get("from");if(h&&0!==h.length){if(h&&h.length){var c=l;i.toDates=_.reduce(h,function(e,t){if(_.isNumber(t)){var i=s(c,t);e.push(a(i,"/")),c=i}else e.push("");return e},[])}}else i.toDates=[a(s(l,this.model.DEFAULT_INTERVAL),"/")];return i},getInitialParameter:function(){var e,t=this.$el.attr("data-initialParameter");return e=t?new Function("return "+t)():{},this.isDepartureTypeDomestic&&!e.departure&&(e.departure="TYO"),e},_initializeDates:function(e){this._setupFromDate(e.from),this._setupToDates(e.fromDate||this.model.getDefaultFromAndToDate().from,[e.to])},_setupDate:function(e,t,i){var s,a=n(d(e),"/");i?(s=t.find(".depart-date"),t.data("fromdate",e)):((s=t.find(".return-date")).length||(s=t.find(".depart-date")),t.data("todate",e)),s.html(r(this.dateLabelFormat,a.substring(0,5),a.substring(5,a.length)))},_setupFromDate:function(e){var t=this.$(".firstSchedule");this._setupDate(e,t,!0)},_setupToDates:function(e,i){var r=i&&0<i.length?i[0]:this.model.getToDate(e);if(r){var s=this.$(".firstSchedule");this._setupDate(r,s)}var a=i&&i.length?i:[r],n=r||e;_.each(this.$(".item-destination-box"),function(e,i){var r=t(e),s=a.length>i?a[i]:n;n=s||n;var o=s||n;if(this._setupDate(o,r.find(".stopoverSchedule")),""===s){var d=r.find(".isOpenjaw");d.prop("checked",!0),d.change()}},this)},_setupDeparture:function(e){var t=this.$(".allDeparture");t.data("code",e);var i=this.model.getAirportLabel(e);i&&(t.find(".select-city").text(i),t.parent().addClass("selected"))},_setupArrival:function(e){var t=this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripArrival"):this.$(".stopoverArrival");t.data("code",e);var i=this.model.getAirportLabel(e);i&&t.find(".arrivalLabel").text(i)},_setupDestination:function(e,t){e.data("code",t);var i=this.model.getAirportLabel(t);i&&(e.find(".select-city").text(i),e.hasClass("onewayOrRoundtripDestination")&&e.parent().addClass("selected"))},_setupAdult:function(e){var t=this.$(".adultNum");t.data("adultnum",e),t.text(e+"名")},_setupMinorAges:function(e){var t=this.$(".minorAges");t.data("minorages",e.join(",")),t.text(e.length+"名")},changeSearchKind:function(e){var i=t(e.currentTarget);this._changeSearchKind(+i.val())},_changeSearchKind:function(e){if(this.currentSearchKind!==e){var t=this.$(".tab-switch-01");t.children().removeClass("active"),t.find(r(".searchKind[value={0}]",e)).parent().addClass("active");var i,s=this.$(".wrapper-air-search"),a=this.$(".firstSchedule").find(".return-date");i=e===f.ROUNDTRIP?(s.removeClass("one-way"),s.removeClass("round-tour"),this._show(a),this._adjustDate(),this.currentSearchKind===f.STOPOVER):e===f.ONEWAY?(s.removeClass("round-tour"),s.addClass("one-way"),this._hide(a),this.currentSearchKind===f.STOPOVER):(s.removeClass("one-way"),s.addClass("round-tour"),this._hide(a),this.currentSearchKind!==f.STOPOVER),this.currentSearchKind=e,i&&this._syncSearchCondition()}},_syncDestination:function(e,t){var i=e.data("code"),r=e.find(".select-city").text();t.data("code",i),t.find(".select-city").text(r)},_syncArrival:function(e,t){var i=e.data("code"),r=e.find(".arrivalLabel").text();t.data("code",i),t.find(".arrivalLabel").text(r)},_syncSearchCondition:function(){var e=this.$(".onewayOrRoundtripDestination"),i=this.$(".onewayOrRoundtripArrival"),r=t(this.$(".stopoverDestination").get(0)),s=this.$(".stopoverArrival");this._isOnewayOrRoundtrip()?(this._syncDestination(r,e),this._syncArrival(s,i)):(this._syncDestination(e,r),this._syncArrival(i,s))},_getVisibleDestinations:function(){var e=0;return _.some(this.$(".item-destination-box"),function(i){return t(i),!!t(i).hasClass("none")||(e++,!1)}),e},navigatePassengerModal:function(e){var t=[document.body.scrollTop||document.documentElement.scrollTop];Backbone.history.navigate("showPassengerModal/"+t.join("/"),{trigger:!0})},callPassengerModal:function(e,t){var i=this.$(".adultNum").data("adultnum"),r=this._getMinorAges();this.passengerModalView.show({top:t.top,hideTargetSelector:this.hideTargetSelectors,adultNum:i,minorAges:r})},selectPassenger:function(e,t){this._setupAdult(t.adultNum),this._setupMinorAges(t.minorAges)},navigateSingleDestinationModal:function(e){var i=[document.body.scrollTop||document.documentElement.scrollTop],r=t(e.currentTarget).hasClass("allDeparture")?"departure":"arrival";i.push(r),Backbone.history.navigate("showSingleDestinationModal/"+i.join("/"),{trigger:!0})},callSingleDestinationModal:function(e,t){var i;if("departure"===t.type)i=this.$(".allDeparture").data("code");else{if("arrival"!==t.type)return;i=this._getArrivalPort()}this.singleDestinationModalView.show({type:t.type,top:t.top,hideTargetSelector:this.hideTargetSelectors,code:i})},selectSingleDestination:function(e,t){this._setupArrival(t.code),"departure"===t.type&&this._setupDeparture(t.code)},navigateMultiStageDestinationModal:function(e){var i,r=[document.body.scrollTop||document.documentElement.scrollTop],s=t(e.currentTarget);i=s.hasClass("allDeparture")?"departure":s.hasClass("onewayOrRoundtripArrival")?"arrival":this._isOnewayOrRoundtrip()?9:s.hasClass("stopoverArrival")?"stopoverArrival":s.parents(".item-destination-box").data("index"),r.push(i),Backbone.history.navigate("showMultiStageDestinationModal/"+r.join("/"),{trigger:!0})},_getMultiStageDestinationEventFireElement:function(e){var i;return"departure"===e.type?i=this.$(".allDeparture"):"arrival"===e.type?i=this.$(".onewayOrRoundtripArrival"):"stopoverArrival"===e.type?i=this.$(".stopoverArrival"):_.isNumber(e.index)&&(i=this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripDestination"):t(this.$(".stopoverDestination").get((9===e.index?1:e.index)-1))),i},callMultiStageDestinationModal:function(e,t){var i=this._getMultiStageDestinationEventFireElement(t);if(i){var r=i.data("code");this.multiStageDestinationModalView.show({top:t.top,hideTargetSelector:this.hideTargetSelectors,type:t.type,index:t.index,code:r,isOverseas:!this.isDepartureTypeDomestic})}},selectMultiStageDestination:function(e,t){if("departure"===t.type)this._setupDeparture(t.code),this._setupArrival(t.code);else if("arrival"===t.type||"stopoverArrival"===t.type)this._setupArrival(t.code);else{var i=this._getMultiStageDestinationEventFireElement(t);if(!i)return;var r=this.model.getAirportLabel(t.code);if(!r)return;i.data("code",t.code),i.find(".select-city").text(r),this._isOnewayOrRoundtrip()&&i.parent().addClass("selected")}},showCalendar:function(e){var i,r=t(e.currentTarget),s=[document.body.scrollTop||document.documentElement.scrollTop,this.hideTargetSelectors];if(this.currentSearchKind===f.ROUNDTRIP){i="#showRoundtripCalendar/";var a=r.find(".firstSchedule");s.push(a.data("fromdate")),s.push(a.data("todate"))}else if(this.currentSearchKind===f.ONEWAY)i="#showOnewayCalendar/",a=r.find(".firstSchedule"),s.push(a.data("fromdate"));else{i="#showStopoverCalendar/";var n=r.find(".ico-schedule"),o=null!=n.data("index")?n.data("index"):n.parents(".item-destination-box").data("index"),d=0===o?n.data("fromdate"):n.data("todate");if(s.push(o),s.push(d),0<o){var h=this._getBeforeDateValue(o);s.push(h)}}location.hash=i+_.map(s,function(e){return encodeURIComponent(e)}).join("/")},_getBeforeDateValue:function(e){if(1===e)return this.$(".firstSchedule").data("fromdate");for(var i=this.$(".item-destination-box").find(".box-no-airplane"),r=this.$(".ico-schedule"),s=e-1;-1<s;s--){var a=s-1;if(0<=a){var n=t(i.get(a));if(n.length&&n.find(".isOpenjaw:checked").val())continue}var o=t(r.get(s));return o.data("fromdate")||o.data("todate")}},closeCalendar:function(e,i){if(this._isOnewayOrRoundtrip()){if(this._setupFromDate(i.from),i.to){var r=this.$(".firstSchedule");this._setupDate(i.to,r)}}else{var s=this.$(".stopoverSchedule");0===i.index?this._setupFromDate(i.from):this._setupDate(i.from,t(s.get(i.index-1))),_.each(s,function(e,r){if(r>i.index-1){var s=t(e),a=s.data("todate");0<h(d(i.from),d(a))&&this._setupDate(i.from,s)}},this)}},setDeparture:function(e,t){var i=t.code;this._changeSearchKind(f.ROUNDTRIP),this._setupDeparture(i),this._setupArrival(i)},setDestination:function(e,t){var i=t.code;this._changeSearchKind(f.ROUNDTRIP),this._setupDestination(this.$(".onewayOrRoundtripDestination"),i)},setFromDate:function(e,t){var i=t.fromDate;this._changeSearchKind(f.ROUNDTRIP),this._setupFromDate(i),this._setupToDates(i)},setToDate:function(e,t){var i=t.toDate;this._changeSearchKind(f.ROUNDTRIP),this._setupToDates(this.$(".firstSchedule").data("fromdate"),[i])},_adjustDate:function(){var e=this.$(".firstSchedule"),t=d(e.data("fromdate")),i=d(e.data("todate"));i<t&&(i=s(t,this.model.DEFAULT_INTERVAL),this._setupDate(a(i,"/"),e))},_search:function(e){t("#modal-loading-01").trigger("click"),this.model.executeSearch(e)},_hideSearchModal:function(){t("#modal-overlay").remove(),t("#modal-loading-01").hide()},moveToPage:function(e){location.href=e.get("redirectUrl"),this._hideSearchModal()},searchAir:function(e){var t,i=this.currentSearchKind;if(!(t=i===f.ROUNDTRIP?this._searchRoundtrip():i===f.ONEWAY?this._searchOneway():this._searchStopoverOrOpenjaw()))return!1;if(this.isResearch||this._saveCondition(t),this._saveCondition(t),this._isOnewayOrRoundtrip()&&this.sendGA){var r=this;this.model.sendDataToGoogleAnalytics(t).done(function(){r._search(t)})}else this._search(t)},getContainerId:function(){var e="spairform",t=this.$el.attr("data-savekeyprefix");return t?t+"_"+e:e},_saveCondition:function(e){var t={searchKind:e.searchKind,fromDate:e.fromDate,toDates:e.toDates,departure:e.departure,arrival:e.arrival?e.arrival:"",destinations:e.destinations,adultNum:e.adultNum,minorAges:e.minorAges,direct:e.direct,openFix:e.openFix,seatClass:e.seatClass,omitLcc:e.omitLcc,depTimes:e.depTimes,carriers:e.carriers,AgentCode:e.AgentCode};this.model.saveCondition(this.getContainerId(),t)},_handleErrorMessage:function(e){alert(e.join("\n"))},_getToDates:function(){return(this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripSchedule"):this.$(".stopoverSchedule")).find(".fromDate").val()},_createCommonCondition:function(){var e=this._getDeparturePort(),t=this._getDestinations(),i=this.$(".firstSchedule").data("fromdate"),r=this.$(".adultNum").data("adultnum"),s=this._getMinorAges(),a=this.$("input[name=AgentCode]").val(),n={searchKind:this.currentSearchKind,fromDate:i,departure:e,destinations:t,adultNum:r,AgentCode:a};s&&0<s.length&&(n.minorAges=s),this.$(".direct:checked").val()&&(n.direct=1);var o=this.$("#seat-cls").val();if(o&&(n.seatClass=o),this.currentSearchKind!==f.STOPOVER&&this.isDepartureTypeDomestic){var d=_.reduce(this.$(".depTimes:checked"),function(e,t){return e.push(t.value),e},[]);0<d.length&&(n.depTimes=d);var h=this.$("#carrier-select").val();h&&(n.carriers=h)}var l=this.$(".openFix:checked").val();l&&(n.openFix=l);var c=this.$(".omitLcc:checked").val();return c&&(n.omitLcc=c),this.isResearch&&this._order&&(n.order=this._order),n},_searchOneway:function(){var e=this._createCommonCondition(),t=this.model.validateOneway(e,!this.isDepartureTypeDomestic);return t.length?(this._handleErrorMessage(t),!1):e},_searchRoundtrip:function(){var e=this._createCommonCondition();e.arrival=this._getArrivalPort(),e.toDates=[this.$(".firstSchedule").data("todate")];var t=this.model.validateRoundtrip(e,!this.isDepartureTypeDomestic);return t.length?(this._handleErrorMessage(t),!1):e},_searchStopoverOrOpenjaw:function(){var e=this._createCommonCondition();e.arrival=this._getArrivalPort();var i=this.$(".item-destination-box"),r=[];e.toDates=_.reduce(i,function(e,i,s){var a=t(i);if(a.is(":visible")){var n=a.find(".stopoverSchedule").data("todate"),o=a.find(".isOpenjaw").is(":checked");r.push(o),o&&(n=""),e.push(n)}return e},[],this),_.contains(r,!0)&&(e.searchKind=f.OPENJAW);var s=this.model.validateStopoverOrOpenjaw(e,r,!this.isDepartureTypeDomestic);return s.length?(this._handleErrorMessage(s),!1):e},_getDeparturePort:function(){return this.$(".allDeparture").data("code")},_isOnewayOrRoundtrip:function(){return this.currentSearchKind===f.ROUNDTRIP||this.currentSearchKind===f.ONEWAY},_getArrivalPort:function(){return this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripArrival").data("code"):this.$(".stopoverArrival").data("code")},hideDestination:function(e){var i=t(e.currentTarget).parents(".item-destination-box").data("index")-1,r=this.$(".item-destination-box"),s=this._getVisibleDestinations();if(_.each(_.range(i,s-1),function(e){var i=t(r.get(e)),a=t(r.get(e+1));this._setupDate(a.find(".stopoverSchedule").data("todate"),i.find(".stopoverSchedule"));var n=a.find(".isOpenjaw:checked").val(),o=i.find(".isOpenjaw"),d=i.find(".box-no-airplane");n&&1!==s?(o.prop("checked",!0),d.addClass("active"),this._hide(i.find(".item-schedule-01"))):(o.prop("checked",!1),d.removeClass("active"),this._show(i.find(".item-schedule-01")));var h=i.find(".stopoverDestination"),l=a.find(".stopoverDestination");h.data("code",l.data("code")||""),h.html(l.html())},this),2==s){this._hide(this.$(".link-delete-01"));var a=t(r.get(0));a.find(".isOpenjaw:checked").val()&&(a.find(".isOpenjaw").prop("checked",!1),a.find(".box-no-airplane").removeClass("active"),this._show(a.find(".item-schedule-01")))}var n=s-1,o=n-1;this._hide(t(r.get(n)));var d=t(r.get(o));this._show(this.$(".btn-add-box-01")),this._show(d.find(".item-schedule-01"));var h=d.find(".isOpenjaw"),l=d.find(".box-no-airplane");h.prop("checked",!1),l.removeClass("active"),this._hide(t(d.find(".box-no-airplane")))},showNextDestination:function(e){this._showDestination()},_showDestination:function(){var e=this.$(".item-destination-box"),i=this._getVisibleDestinations(),r=t(e.get(i-1)),s=i,a=t(e.get(i));this._show(r.find(".box-no-airplane")),this._show(a),this._show(this.$(".link-delete-01")),4===s&&this._hide(this.$(".btn-add-box-01"))},showOrHideOptionalCondition:function(e,i){var r=t(e.currentTarget);r.hasClass("active")?r.removeClass("active"):r.addClass("active")},toggleOpenjaw:function(e){var i,r=t(e.currentTarget),s=r.parents(".item-destination-box"),a=r.is(":checked"),n=s.data("index")-1,o=this.$(".item-destination-box");_.each(o,function(e,r){var s=r,o=t(e),l=o.find(".item-schedule-01"),c=l.find(".stopoverSchedule");if(c.length&&n===s){var u=o.find(".box-no-airplane");a?(u.addClass("active"),this._hide(l)):(u.removeClass("active"),this._show(l)),i=c.data("todate")}else if(c.length&&!a&&n<r){var p=c.data("todate");h(d(p),d(i))<0&&this._setupDate(i,c)}},this)},_getReverseDirections:function(){return this.isDepartureTypeDomestic?this.model.get("reverseDirections"):this.model.get("reverseDirectionsOverseas")},_getDestinations:function(){return this._isOnewayOrRoundtrip()?[this.$(".onewayOrRoundtripDestination").data("code")]:_.reduce(this.$(".stopoverDestination"),function(e,i){return t(i).is(":visible")&&e.push(t(i).data("code")),e},[])},_getMinorAges:function(e){var t=[],i=this.$(".minorAges").data("minorages");return i&&(t=_.map(i.split(","),function(e){return+e})),t},_clearParameter:function(){this.$(".searchKind[value=0]").prop("checked",!0);var e=this;_.defer(function(){e.$("select").prop("selectedIndex",0)}),this.$("input[type=checkbox]").prop("checked",!1)},_show:function(e){_.each(_.toArray(arguments),function(e){e.removeClass("none")})},_hide:function(e){_.each(_.toArray(arguments),function(e){e.addClass("none")})}}),C=skygate.util.namespace("airlink.view.sp.multi_search_form");C.AirFormView=D,C.AirFormRouterBase=c,C.AirFormModalBaseView=p,C.AirFormRouterForLp=u}(window,jQuery);