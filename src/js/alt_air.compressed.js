!function(r,c){var a=c(document),n=skygate.util.format,o=skygate.util.date.computeDate,d=skygate.util.date.toYmdString,h=skygate.util.date.toYmdStringWithDayOfTheWeek,l=skygate.util.date.ymdStringToObject,u=skygate.util.date.ymdStringToObjectWithSeparator,p=skygate.util.date.diffDate,m=airlink.model.common.multi_search_form.AirFormModel,e={routes:{"showSingleDestinationModal/:top/:type":"triggerShowSingleDestinationModal","showMultiStageDestinationModal/:top/:origin":"triggerShowMultiStageDestinationModal","showPassengerModal/:top":"triggerShowPasengerModal","showRoundtripCalendar/:top/:hideTargetSelector/:from/:to":"triggerShowRoundtripCalendar","showOnewayCalendar/:top/:hideTargetSelector/:from":"triggerShowOnewayCalendar","showStopoverCalendar/:top/:hideTargetSelector/:index/:from/:before":"triggerShowStopoverCalendar","showStopoverCalendar/:top/:hideTargetSelector/:index/:from":"triggerShowStopoverCalendar","*default":"hideAirFormModals"},routesToBeReset:{showSingleDestinationModal:1,showMultiStageDestinationModal:1,showPassengerModal:1,showRoundtripCalendar:1,showOnewayCalendar:1,showStopoverCalendar:1},initialize:function(){_.bindAll(this),_.any(_.keys(this.routesToBeReset),function(e){return 1===location.hash.indexOf(e)})&&(location.hash="")},triggerShowSingleDestinationModal:function(e,t){a.trigger("showSingleDestinationModal",{top:+e,type:t})},triggerShowMultiStageDestinationModal:function(e,t){var i={top:+e};if(_.isNaN(+t)){if("departure"!==t&&"arrival"!==t&&"stopoverArrival"!==t)return;i.type=t}else i.index=+t;a.trigger("showMultiStageDestinationModal",i)},triggerShowPasengerModal:function(e){a.trigger("showPassengerModal",{top:+e})},triggerShowRoundtripCalendar:function(e,t,i,r){a.trigger("showOnewayOrRoundtripCalendar",{top:+e,hideTargetSelector:t,from:i,to:r})},triggerShowOnewayCalendar:function(e,t,i){a.trigger("showOnewayOrRoundtripCalendar",{top:+e,hideTargetSelector:t,from:i})},triggerShowStopoverCalendar:function(e,t,i,r,s){a.trigger("showStopoverCalendar",{top:+e,hideTargetSelector:t,index:+i,from:r,before:s})},hideAirFormModals:function(){a.trigger("hideCalendar"),a.trigger("hideSingleDestinationModal"),a.trigger("hideMultiStageDestinationModal"),a.trigger("hidePassengerModal")}},t=Backbone.Router.extend(e),i=Backbone.View.extend({hide:function(e){this.$el.is(":visible")&&(this._show(c(this.hideTargetSelector)),this._hide(this.$el),r.scrollTo(0,this.originalTop||0))},close:function(e){history.back()},_show:function(e){e.removeClass("none")},_hide:function(e){e.addClass("none")}}),g=i.extend({el:".modal-number",btnDisabledClass:"btn-disabled",events:{"click .btn-conversion-01":"decide","click .box-btn-close-01":"close","click .incrementAdult":"incrementAdult","click .decrementAdult":"decrementAdult","click .incrementChild":"incrementChild","click .decrementChild":"decrementChild"},initialize:function(e){if(!e||!e.airFormModel)throw new Error("airFormModel is required");this.model=e.airFormModel,_.bindAll(this),this.$adultBox=this.$(".adultBox"),this.$adultIncrementBtn=this.$adultBox.find(".incrementAdult"),this.$adultDecrementBtn=this.$adultBox.find(".decrementAdult"),this.$childBox=this.$(".childBox"),this.$childIncrementBtn=this.$childBox.find(".incrementChild"),this.$childDecrementBtn=this.$childBox.find(".decrementChild"),this.$childAgeWrapper=this.$(".wrapper-child-detail"),this.$childAgeBoxes=this.$(".childAgeBox"),a.on("hidePassengerModal",this.hide)},show:function(e){this.originalTop=e.top,this.hideTargetSelector=e.hideTargetSelector;var t=e.adultNum,i=e.minorAges;_.each(i,function(e,t){c(this.$("select").get(t)).val(e)},this),this._setChildNum(i.length),this._adjustAdultBtnState(t),this._adjustChild(t),this._setAdultNum(t),this._show(this.$el),this._hide(c(this.hideTargetSelector)),_.defer(function(){r.scrollTo(0,0)})},incrementAdult:function(e){if(!this.$adultIncrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentAdultNum()+1;this._adjustAdultBtnState(t),this._adjustChild(t),this._setAdultNum(t)}},decrementAdult:function(e){if(!this.$adultDecrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentAdultNum()-1;this._adjustAdultBtnState(t),this._adjustChild(t),this._setAdultNum(t)}},_adjustAdultBtnState:function(e){9===e?(this.$adultIncrementBtn.addClass(this.btnDisabledClass),this.$adultDecrementBtn.removeClass(this.btnDisabledClass)):1===e?(this.$adultIncrementBtn.removeClass(this.btnDisabledClass),this.$adultDecrementBtn.addClass(this.btnDisabledClass)):(this.$adultIncrementBtn.removeClass(this.btnDisabledClass),this.$adultDecrementBtn.removeClass(this.btnDisabledClass))},incrementChild:function(e){if(!this.$childIncrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentChildNum()+1,i=this._getCurrentAdultNum();4!==t&&t!==this._getCurrentAdultNum()&&i+t!==9||this.$childIncrementBtn.addClass(this.btnDisabledClass),this.$childDecrementBtn.removeClass(this.btnDisabledClass),this._setChildNum(t)}},decrementChild:function(e){if(!this.$childDecrementBtn.hasClass(this.btnDisabledClass)){var t=this._getCurrentChildNum()-1;this.$childIncrementBtn.removeClass(this.btnDisabledClass),0===t&&this.$childDecrementBtn.addClass(this.btnDisabledClass),this._setChildNum(t)}},_adjustChild:function(e){var t=this._getCurrentChildNum(),i=e+t,r=t;9===i?this.$childIncrementBtn.addClass(this.btnDisabledClass):9<i?(this.$childIncrementBtn.addClass(this.btnDisabledClass),r=t-1,this._setChildNum(r)):t===e?this.$childIncrementBtn.addClass(this.btnDisabledClass):e<t?(this.$childIncrementBtn.addClass(this.btnDisabledClass),r=t-1,this._setChildNum(r)):this.$childIncrementBtn.removeClass(this.btnDisabledClass),0===r?this.$childDecrementBtn.addClass(this.btnDisabledClass):this.$childDecrementBtn.removeClass(this.btnDisabledClass)},_getCurrentAdultNum:function(){return+this.$adultBox.find(".num-count-txt-01").text()},_getCurrentChildNum:function(){return+this.$childBox.find(".num-count-txt-01").text()},_setAdultNum:function(e){return this.$adultBox.find(".num-count-txt-01").text(e)},_setChildNum:function(r){return 0===r?this.$childAgeWrapper.addClass("none"):(this.$childAgeWrapper.removeClass("none"),_.each(this.$childAgeBoxes,function(e,t){var i=c(e);t<r?i.removeClass("none"):i.addClass("none")})),+this.$childBox.find(".num-count-txt-01").text(r)},decide:function(e){var t=this._getCurrentAdultNum(),i=_.map(_.filter(this.$("select"),function(e){return c(e).is(":visible")}),function(e){return+c(e).val()});a.trigger("selectPassenger",{adultNum:t,minorAges:i}),this.close()}}),v=i.extend({el:".modal-select-point-01",domesticAirportFormat:'<li><a href="javascript:void(0);" class="domesticAirport" data-value="{0}">{1}</a></li>',headerText:{departure:"出発地を選択",arrival:"帰国到着地を選択"},events:{"click .domesticAirport":"select","click .box-btn-close-01":"close"},initialize:function(e){if(!e||!e.airFormModel)throw new Error("airFormModel is required");this.model=e.airFormModel,_.bindAll(this),a.on("hideSingleDestinationModal",this.hide),this._renderContent()},show:function(e){this.originalTop=e.top,this.hideTargetSelector=e.hideTargetSelector,this.type=e.type,this.currentCode=e.code,this.$(".hdg-search-01").text(this.headerText[this.type]),this._show(this.$el),this._hide(c(this.hideTargetSelector));var t=this;_.defer(function(){var e=t.$("a[data-value="+t.currentCode+"]");t.currentCode&&e.length?skygate.util.moveTo(e.get(0),0):r.scrollTo(0,0)})},_renderContent:function(){var e=_.reduce(this.model.get("domesticAirports"),function(e,t){return e+=n(this.domesticAirportFormat,t.code,t.label)},"",this);this.$(".list-search-01").html(e)},select:function(e){var t=c(e.currentTarget).data("value");t&&(a.trigger("selectSingleDestination",{type:this.type,code:t}),this.close())}}),f=i.extend({el:".modal-select-point-02",areaFormat:'<li><a href="javascript: void(0);" class="selectArea" data-areaIndex="{0}">{1}</a></li>',countryFormat:'<li><a href="javascript: void(0);" class="selectCountry" data-countryIndex="{0}">{1}</a></li>',portFormat:'<li><a href="javascript: void(0);" class="selectPort" data-portCode="{0}">{1}</a></li>',breadcrumbAreaFormat:'<a href="javascript: void(0);">{0}</a>',headerText:{departure:"出発地を選択",arrival:"帰国到着地を選択",stopoverArrival:"到着地を選択",destination:"目的地を選択",area:"まずはエリアを選択してください",country:"次に国を選択してください",port:"都市を選択してください"},events:{"click .selectArea":"selectArea","click .selectCountry":"selectCountry","click .selectPort":"selectPort","click .js-prev-area":"toArea","click .js-prev-country":"toCountry","click .box-btn-close-01":"close"},initialize:function(e){if(!e||!e.airFormModel)throw new Error("airFormModel is required");this.model=e.airFormModel,_.bindAll(this),this.$areaWrapper=this.$(".wrapper-select-area"),this.$countryWrapper=this.$(".wrapper-select-country"),this.$portWrapper=this.$(".wrapper-select-city"),this.$backToAreaLink=this.$(".box-btn-prev").find(".js-prev-area"),this.$backToCountryLink=this.$(".box-btn-prev").find(".js-prev-country"),a.on("hideMultiStageDestinationModal",this.hide)},_renderArea:function(){var e=_.reduce(this._getDirections(),function(e,t){var i=this.model.hasEffectiveChildForDirection(t)?t.code:-1;return e+=n(this.areaFormat,i,t.name)},"",this);this.$(".js-area-select").html(e)},_renderCountry:function(e){var t;this._countries||(this._countries={}),this._countries[e]?t=this._countries[e]:(t=_.reduce(this._getDirections()[e].areas,function(e,t){var i=this.model.hasEffectiveChildForArea(t)?t.code:-1;return e+=n(this.countryFormat,i,t.name)},"",this),this._countries[e]=t),this.$(".js-country-select").html(t)},_renderPorts:function(e,t){this._ports||(this._ports={});var i=e+"_"+t;if(!this._ports[i]){var r=_.reduce(this._getDirections()[e].areas[t].cities,function(e,t){return e+=n(this.portFormat,t.code,t.name)},"",this);this._ports[i]=r}this.$(".js-port-select").html(this._ports[i])},_renderBreadcrumb:function(e,t){var i=this.$(".box-selectpoint"),r=i.find(".point-01"),s=i.find(".point-02");e&&t?(i.removeClass("none"),r.html(n(this.breadcrumbAreaFormat,e)).removeClass("none"),s.text(t).removeClass("none")):e?(i.removeClass("none"),r.html(e).removeClass("none"),s.addClass("none").text("")):(i.addClass("none"),r.addClass("none"))},selectArea:function(e){var t=c(e.currentTarget),i=t.data("areaindex");-1!==i&&(t.addClass("selected"),this._renderCountry(i),this.toCountry())},selectCountry:function(e){var t=c(e.currentTarget),i=t.data("countryindex");if(-1!==i){var r=this._getSelectedAreaInfo();r&&(t.addClass("selected"),this._renderPorts(r.areaIndex,i),this.toPort())}},selectPort:function(e){var t=c(e.currentTarget).data("portcode");t&&(a.trigger("selectMultiStageDestination",{type:this.type,index:this.index,code:t}),this.close())},toArea:function(e){_.defer(this._toArea)},toCountry:function(e){_.defer(this._toCountry)},toPort:function(e){_.defer(this._toPort)},_toArea:function(){this.$areaWrapper.removeClass("prev"),this.$areaWrapper.addClass("select"),this.$countryWrapper.removeClass("select"),this.$countryWrapper.removeClass("prev"),this.$portWrapper.removeClass("select"),this.$(".selectArea").removeClass("selected"),this.$(".selectCountry").removeClass("selected"),this.$backToAreaLink.addClass("none"),this.$backToCountryLink.addClass("none"),this._renderBreadcrumb(),this._updateModalHeaderText(this.headerText.area),this._toTargetPosition()},_toCountry:function(){this.$areaWrapper.removeClass("select"),this.$areaWrapper.addClass("prev"),this.$countryWrapper.removeClass("prev"),this.$countryWrapper.addClass("select"),this.$portWrapper.removeClass("select"),this.$backToAreaLink.removeClass("none"),this.$backToCountryLink.addClass("none"),this.$(".selectCountry").removeClass("selected"),this._renderBreadcrumb(this._getSelectedAreaInfo().name),this._updateModalHeaderText(this.headerText.country),this._toTargetPosition()},_toPort:function(){this.$countryWrapper.removeClass("select"),this.$countryWrapper.addClass("prev"),this.$portWrapper.addClass("select"),this.$backToAreaLink.addClass("none"),this.$backToCountryLink.removeClass("none"),this._renderBreadcrumb(this._getSelectedAreaInfo().name,this._getSelectedCountryInfo().name),this._updateModalHeaderText(this.headerText.port),this._toTargetPosition()},_getSelectedAreaInfo:function(){var e=c(_.find(this.$(".selectArea"),function(e){return c(e).hasClass("selected")})),t=e.data("areaindex");if(e.length&&-1!==t)return{areaIndex:t,name:e.text()}},_getSelectedCountryInfo:function(){var e=c(_.find(this.$(".selectCountry"),function(e){return c(e).hasClass("selected")})),t=e.data("countryindex");if(e.length&&-1!==t)return{countryIndex:t,name:e.text()}},_updateModalHeaderText:function(e){this.$(".box-search-hdg-01").find(".hdg-search-02").text(e)},_getDirections:function(){return this.isOverseas?this.model.get("directionsOverseas"):this.model.get("directions")},_getReverseDirections:function(){return this.isOverseas?this.model.get("reverseDirectionsOverseas"):this.model.get("reverseDirections")},show:function(e){this.originalTop=e.top,this.hideTargetSelector=e.hideTargetSelector,this.type=e.type,this.index=e.index,this.currentCode=e.code,this.isOverseas=e.isOverseas;var t=this.headerText[this.type]||this.headerText.destination;this.$(".hdg-search-01").text(t),this._restoreState(),this._show(this.$el),this._hide(c(this.hideTargetSelector))},_restoreAreaState:function(t,e,i){var r=c(_.find(this.$(".selectArea"),function(e){return c(e).data("areaindex")==t}));r.length&&(r.click(),null!=e&&_.defer(this._restoreCountryState,e,i))},_restoreCountryState:function(t,i){var e=c(_.find(this.$(".selectCountry"),function(e){return c(e).data("countryindex")==t}));if(e.length&&(e.click(),i)){var r=c(_.find(this.$(".selectPort"),function(e){return c(e).data("portcode")==i}));r.length&&_.defer(this._toTargetPosition,r.get(0))}},_restoreState:function(){var e,t,i;if(this._renderArea(),this.currentCode){var r=this._getReverseDirections()[this.currentCode];if(r)e=r.areaIndex,t=r.countryIndex,i=this.currentCode;else{var s=this.model.findAreaOrCountry(this._getDirections(),this.currentCode);s&&(e=s.areaIndex,t=s.countryIndex)}}null==e&&null==t?(this._toArea(),this._toTargetPosition()):this._restoreAreaState(e,t,i)},_toTargetPosition:function(t){var i=this;_.defer(function(){if(t){var e=i.$(".fixed-area-01").height();skygate.util.moveTo(t,-e)}else r.scrollTo(0,0)})}}),D={ROUNDTRIP:0,ONEWAY:2,STOPOVER:4,OPENJAW:3},s=Backbone.View.extend({el:".airFormContainer",currentSearchKind:D.ROUNDTRIP,isDepartureTypeDomestic:!0,dateLabelFormat:'{0}<strong class="time">{1}</strong>',hideTargetSelectors:"#article-content, #searchFormModal, [data-role=content], [data-role=searchForm]",events:{"click .btn-conversion-01":"searchAir","click .searchKind":"changeSearchKind","click .item-number-01":"navigatePassengerModal","click .showSingleDestinationModal":"navigateSingleDestinationModal","click .showMultiStageDestinationModal":"navigateMultiStageDestinationModal","click .showCalendar":"showCalendar","click .link-delete-01":"hideDestination","click .btn-add-01":"showNextDestination","change .isOpenjaw":"toggleOpenjaw","click .toggle-search-trigger":"showOrHideOptionalCondition"},initialize:function(e){_.bindAll(this),this.isDepartureTypeDomestic=!e||!e.isDepartureTypeAbroad,this.isResearch=e&&e.isResearch,this.sendGA=!1,this.model=new m,this.model.setup(!this.isDepartureTypeDomestic);var t=this.model.getDefaultFromAndToDate();this._initializeDates(t),this._clearParameter(),this.passengerModalView=new g({airFormModel:this.model}),this.isDepartureTypeDomestic&&(this.singleDestinationModalView=new v({airFormModel:this.model})),this.multiStageDestinationModalView=new f({airFormModel:this.model}),a.on("showPassengerModal",this.callPassengerModal),a.on("selectPassenger",this.selectPassenger),a.on("showSingleDestinationModal",this.callSingleDestinationModal),a.on("selectSingleDestination",this.selectSingleDestination),a.on("showMultiStageDestinationModal",this.callMultiStageDestinationModal),a.on("selectMultiStageDestination",this.selectMultiStageDestination),a.on("closeCalendar",this.closeCalendar);var i=this.getInitialParameter();i&&(i.sendGA&&(this.sendGA=!0),i=this._convertInitialParameter(i));var r=(this.isResearch?this._convertQuery(this.$el.data("query")):this.model.getSavedCondition(this.getContainerId()))||i;if(r){var s=this;_.defer(function(){s.restoreCondition(r)})}this.$el.on("SetAirDeparture",this.setDeparture),this.$el.on("SetAirDestination",this.setDestination),this.$el.on("SetAirFromDate",this.setFromDate),this.$el.on("SetAirToDate",this.setToDate),this.listenTo(this.model,"change:redirectUrl",this.moveToPage)},restoreCondition:function(e){e.AgentCode&&this.$("input[name=AgentCode]").val(e.AgentCode),this.isResearch&&e.order&&(this._order=e.order);var t=e.searchKind;if(t===D.OPENJAW&&(t=D.STOPOVER),null!=t&&(this.$(n(".searchKind[value={0}]",t)).prop("checked",!0),this._changeSearchKind(t)),e.fromDate&&this._setupFromDate(e.fromDate),this._setupToDates(e.fromDate||this.model.getDefaultFromAndToDate().from,e.toDates),e.departure&&(this._setupDeparture(e.departure),e.arrival||this._setupArrival(e.departure)),e.destinations&&e.destinations.length){var r=this.$(".onewayOrRoundtripDestination"),s=this.$(".stopoverDestination");_.each(e.destinations,function(e,t){0===t&&this._setupDestination(r,e);var i=c(s.get(t));this._setupDestination(i,e),1<t&&this._showDestination()},this)}e.adultNum&&this._setupAdult(+e.adultNum),this._setupMinorAges(e.minorAges||[]),e.arrival&&this._setupArrival(e.arrival);var i=!1;if(this._isOnewayOrRoundtrip()&&(i=this._getDeparturePort()!==this._getArrivalPort()),e.direct&&(this.$(".direct").prop("checked",!0),i=!0),e.openFix&&(this.$(".openFix").prop("checked",!0),i=!0),e.seatClass&&(this.$("#seat-cls").val(e.seatClass),i=!0),e.omitLcc&&(this.$(".omitLcc").prop("checked",!0),i=!0),e.carriers&&(this.$("#carrier-select").val(e.carriers),i=!0),e.depTimes){var a=_.sortBy(this.$(".depTimes"),function(e){return e.value});a.length&&(_.each(e.depTimes,function(e){c(a[+e-1]).click()}),i=!0)}i&&!this.$(".toggle-search-trigger").hasClass("active")&&this.$(".toggle-search-trigger").addClass("active")},_convertQuery:function(e){var t=e.fromDate;t&&-1===t.indexOf("/")&&(e.fromDate=d(l(t),"/"));var i=e.toDates;return i&&0<i.length&&(e.toDates=_.map(i,function(e){return e&&-1===e.indexOf("/")?d(l(e),"/"):e})),e},_convertInitialParameter:function(e){var t=c.extend({},!0,e),i=e.searchKind;t.searchKind=i?D[i.toUpperCase()]:D.ROUNDTRIP;var r=e.fromDate;r&&_.isString(r)&&-1===r.indexOf("/")?t.fromDate=d(l(r),"/"):r&&_.isNumber(r)&&(t.fromDate=d(o(this.model.get("from"),r),"/"));var s=e.toDates,a=t.fromDate?u(t.fromDate,"/"):this.model.get("from");if(s&&0!==s.length){if(s&&s.length){var n=a;t.toDates=_.reduce(s,function(e,t){if(_.isNumber(t)){var i=o(n,t);e.push(d(i,"/")),n=i}else e.push("");return e},[])}}else t.toDates=[d(o(a,this.model.DEFAULT_INTERVAL),"/")];return t},getInitialParameter:function(){var e,t=this.$el.attr("data-initialParameter");return e=t?new Function("return "+t)():{},this.isDepartureTypeDomestic&&!e.departure&&(e.departure="TYO"),e},_initializeDates:function(e){this._setupFromDate(e.from),this._setupToDates(e.fromDate||this.model.getDefaultFromAndToDate().from,[e.to])},_setupDate:function(e,t,i){var r,s=h(u(e),"/");i?(r=t.find(".depart-date"),t.data("fromdate",e)):((r=t.find(".return-date")).length||(r=t.find(".depart-date")),t.data("todate",e)),r.html(n(this.dateLabelFormat,s.substring(0,5),s.substring(5,s.length)))},_setupFromDate:function(e){var t=this.$(".firstSchedule");this._setupDate(e,t,!0)},_setupToDates:function(e,t){var i=t&&0<t.length?t[0]:this.model.getToDate(e);if(i){var r=this.$(".firstSchedule");this._setupDate(i,r)}var n=t&&t.length?t:[i],o=i||e;_.each(this.$(".item-destination-box"),function(e,t){var i=c(e),r=n.length>t?n[t]:o;o=r||o;var s=r||o;if(this._setupDate(s,i.find(".stopoverSchedule")),""===r){var a=i.find(".isOpenjaw");a.prop("checked",!0),a.change()}},this)},_setupDeparture:function(e){var t=this.$(".allDeparture");t.data("code",e);var i=this.model.getAirportLabel(e);i&&(t.find(".select-city").text(i),t.parent().addClass("selected"))},_setupArrival:function(e){var t=this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripArrival"):this.$(".stopoverArrival");t.data("code",e);var i=this.model.getAirportLabel(e);i&&t.find(".arrivalLabel").text(i)},_setupDestination:function(e,t){e.data("code",t);var i=this.model.getAirportLabel(t);i&&(e.find(".select-city").text(i),e.hasClass("onewayOrRoundtripDestination")&&e.parent().addClass("selected"))},_setupAdult:function(e){var t=this.$(".adultNum");t.data("adultnum",e),t.text(e+"名")},_setupMinorAges:function(e){var t=this.$(".minorAges");t.data("minorages",e.join(",")),t.text(e.length+"名")},changeSearchKind:function(e){var t=c(e.currentTarget);this._changeSearchKind(+t.val())},_changeSearchKind:function(e){if(this.currentSearchKind!==e){var t=this.$(".tab-switch-01");t.children().removeClass("active"),t.find(n(".searchKind[value={0}]",e)).parent().addClass("active");var i=this.$(".wrapper-air-search"),r=this.$(".firstSchedule").find(".return-date"),s=!1;s=e===D.ROUNDTRIP?(i.removeClass("one-way"),i.removeClass("round-tour"),this._show(r),this._adjustDate(),this.currentSearchKind===D.STOPOVER):e===D.ONEWAY?(i.removeClass("round-tour"),i.addClass("one-way"),this._hide(r),this.currentSearchKind===D.STOPOVER):(i.removeClass("one-way"),i.addClass("round-tour"),this._hide(r),this.currentSearchKind!==D.STOPOVER),this.currentSearchKind=e,s&&this._syncSearchCondition()}},_syncDestination:function(e,t){var i=e.data("code"),r=e.find(".select-city").text();t.data("code",i),t.find(".select-city").text(r)},_syncArrival:function(e,t){var i=e.data("code"),r=e.find(".arrivalLabel").text();t.data("code",i),t.find(".arrivalLabel").text(r)},_syncSearchCondition:function(){var e=this.$(".onewayOrRoundtripDestination"),t=this.$(".onewayOrRoundtripArrival"),i=c(this.$(".stopoverDestination").get(0)),r=this.$(".stopoverArrival");this._isOnewayOrRoundtrip()?(this._syncDestination(i,e),this._syncArrival(r,t)):(this._syncDestination(e,i),this._syncArrival(t,r))},_getVisibleDestinations:function(){var t=0;return _.some(this.$(".item-destination-box"),function(e){c(e);return!!c(e).hasClass("none")||(t++,!1)}),t},navigatePassengerModal:function(e){var t=[document.body.scrollTop||document.documentElement.scrollTop];Backbone.history.navigate("showPassengerModal/"+t.join("/"),{trigger:!0})},callPassengerModal:function(e,t){var i=this.$(".adultNum").data("adultnum"),r=this._getMinorAges();this.passengerModalView.show({top:t.top,hideTargetSelector:this.hideTargetSelectors,adultNum:i,minorAges:r})},selectPassenger:function(e,t){this._setupAdult(t.adultNum),this._setupMinorAges(t.minorAges)},navigateSingleDestinationModal:function(e){var t=[document.body.scrollTop||document.documentElement.scrollTop],i=c(e.currentTarget).hasClass("allDeparture")?"departure":"arrival";t.push(i),Backbone.history.navigate("showSingleDestinationModal/"+t.join("/"),{trigger:!0})},callSingleDestinationModal:function(e,t){var i;if("departure"===t.type)i=this.$(".allDeparture").data("code");else{if("arrival"!==t.type)return;i=this._getArrivalPort()}this.singleDestinationModalView.show({type:t.type,top:t.top,hideTargetSelector:this.hideTargetSelectors,code:i})},selectSingleDestination:function(e,t){this._setupArrival(t.code),"departure"===t.type&&this._setupDeparture(t.code)},navigateMultiStageDestinationModal:function(e){var t,i=[document.body.scrollTop||document.documentElement.scrollTop],r=c(e.currentTarget);t=r.hasClass("allDeparture")?"departure":r.hasClass("onewayOrRoundtripArrival")?"arrival":this._isOnewayOrRoundtrip()?9:r.hasClass("stopoverArrival")?"stopoverArrival":r.parents(".item-destination-box").data("index"),i.push(t),Backbone.history.navigate("showMultiStageDestinationModal/"+i.join("/"),{trigger:!0})},_getMultiStageDestinationEventFireElement:function(e){var t;return"departure"===e.type?t=this.$(".allDeparture"):"arrival"===e.type?t=this.$(".onewayOrRoundtripArrival"):"stopoverArrival"===e.type?t=this.$(".stopoverArrival"):_.isNumber(e.index)&&(t=this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripDestination"):c(this.$(".stopoverDestination").get((9===e.index?1:e.index)-1))),t},callMultiStageDestinationModal:function(e,t){var i=this._getMultiStageDestinationEventFireElement(t);if(i){var r=i.data("code");this.multiStageDestinationModalView.show({top:t.top,hideTargetSelector:this.hideTargetSelectors,type:t.type,index:t.index,code:r,isOverseas:!this.isDepartureTypeDomestic})}},selectMultiStageDestination:function(e,t){if("departure"===t.type)this._setupDeparture(t.code),this._setupArrival(t.code);else if("arrival"===t.type||"stopoverArrival"===t.type)this._setupArrival(t.code);else{var i=this._getMultiStageDestinationEventFireElement(t);if(!i)return;var r=this.model.getAirportLabel(t.code);if(!r)return;i.data("code",t.code),i.find(".select-city").text(r),this._isOnewayOrRoundtrip()&&i.parent().addClass("selected")}},showCalendar:function(e){var t,i=c(e.currentTarget),r=[document.body.scrollTop||document.documentElement.scrollTop,this.hideTargetSelectors];if(this.currentSearchKind===D.ROUNDTRIP){t="#showRoundtripCalendar/";var s=i.find(".firstSchedule");r.push(s.data("fromdate")),r.push(s.data("todate"))}else if(this.currentSearchKind===D.ONEWAY){t="#showOnewayCalendar/";s=i.find(".firstSchedule");r.push(s.data("fromdate"))}else{t="#showStopoverCalendar/";var a=i.find(".ico-schedule"),n=null!=a.data("index")?a.data("index"):a.parents(".item-destination-box").data("index"),o=0===n?a.data("fromdate"):a.data("todate");if(r.push(n),r.push(o),0<n){var d=this._getBeforeDateValue(n);r.push(d)}}location.hash=t+_.map(r,function(e){return encodeURIComponent(e)}).join("/")},_getBeforeDateValue:function(e){if(1===e)return this.$(".firstSchedule").data("fromdate");for(var t=this.$(".item-destination-box").find(".box-no-airplane"),i=this.$(".ico-schedule"),r=e-1;-1<r;r--){var s=r-1;if(0<=s){var a=c(t.get(s));if(a.length&&a.find(".isOpenjaw:checked").val())continue}var n=c(i.get(r));return n.data("fromdate")||n.data("todate")}},closeCalendar:function(e,s){if(this._isOnewayOrRoundtrip()){if(this._setupFromDate(s.from),s.to){var t=this.$(".firstSchedule");this._setupDate(s.to,t)}}else{var i=this.$(".stopoverSchedule");0===s.index?this._setupFromDate(s.from):this._setupDate(s.from,c(i.get(s.index-1))),_.each(i,function(e,t){if(t>s.index-1){var i=c(e),r=i.data("todate");0<p(u(s.from),u(r))&&this._setupDate(s.from,i)}},this)}},setDeparture:function(e,t){var i=t.code;this._changeSearchKind(D.ROUNDTRIP),this._setupDeparture(i),this._setupArrival(i)},setDestination:function(e,t){var i=t.code;this._changeSearchKind(D.ROUNDTRIP),this._setupDestination(this.$(".onewayOrRoundtripDestination"),i)},setFromDate:function(e,t){var i=t.fromDate;this._changeSearchKind(D.ROUNDTRIP),this._setupFromDate(i),this._setupToDates(i)},setToDate:function(e,t){var i=t.toDate;this._changeSearchKind(D.ROUNDTRIP),this._setupToDates(this.$(".firstSchedule").data("fromdate"),[i])},_adjustDate:function(){var e=this.$(".firstSchedule"),t=u(e.data("fromdate")),i=u(e.data("todate"));i<t&&(i=o(t,this.model.DEFAULT_INTERVAL),this._setupDate(d(i,"/"),e))},_search:function(e){c("#modal-loading-01").trigger("click"),this.model.executeSearch(e)},_hideSearchModal:function(){c("#modal-overlay").remove(),c("#modal-loading-01").hide()},moveToPage:function(e){location.href=e.get("redirectUrl"),this._hideSearchModal()},searchAir:function(e){var t,i=this.currentSearchKind;if(!(t=i===D.ROUNDTRIP?this._searchRoundtrip():i===D.ONEWAY?this._searchOneway():this._searchStopoverOrOpenjaw()))return!1;if(this.isResearch||this._saveCondition(t),this._saveCondition(t),this._isOnewayOrRoundtrip()&&this.sendGA){var r=this;this.model.sendDataToGoogleAnalytics(t).done(function(){r._search(t)})}else this._search(t)},getContainerId:function(){var e="spairform",t=this.$el.attr("data-savekeyprefix");return t?t+"_"+e:e},_saveCondition:function(e){var t={searchKind:e.searchKind,fromDate:e.fromDate,toDates:e.toDates,departure:e.departure,arrival:e.arrival?e.arrival:"",destinations:e.destinations,adultNum:e.adultNum,minorAges:e.minorAges,direct:e.direct,openFix:e.openFix,seatClass:e.seatClass,omitLcc:e.omitLcc,depTimes:e.depTimes,carriers:e.carriers,AgentCode:e.AgentCode};this.model.saveCondition(this.getContainerId(),t)},_handleErrorMessage:function(e){alert(e.join("\n"))},_getToDates:function(){return(this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripSchedule"):this.$(".stopoverSchedule")).find(".fromDate").val()},_createCommonCondition:function(){var e=this._getDeparturePort(),t=this._getDestinations(),i=this.$(".firstSchedule").data("fromdate"),r=this.$(".adultNum").data("adultnum"),s=this._getMinorAges(),a=this.$("input[name=AgentCode]").val(),n={searchKind:this.currentSearchKind,fromDate:i,departure:e,destinations:t,adultNum:r,AgentCode:a};s&&0<s.length&&(n.minorAges=s),this.$(".direct:checked").val()&&(n.direct=1);var o=this.$("#seat-cls").val();if(o&&(n.seatClass=o),this.currentSearchKind!==D.STOPOVER&&this.isDepartureTypeDomestic){var d=_.reduce(this.$(".depTimes:checked"),function(e,t){return e.push(t.value),e},[]);0<d.length&&(n.depTimes=d);var h=this.$("#carrier-select").val();h&&(n.carriers=h)}var l=this.$(".openFix:checked").val();l&&(n.openFix=l);var c=this.$(".omitLcc:checked").val();return c&&(n.omitLcc=c),this.isResearch&&this._order&&(n.order=this._order),n},_searchOneway:function(){var e=this._createCommonCondition(),t=this.model.validateOneway(e,!this.isDepartureTypeDomestic);return t.length?(this._handleErrorMessage(t),!1):e},_searchRoundtrip:function(){var e=this._createCommonCondition();e.arrival=this._getArrivalPort(),e.toDates=[this.$(".firstSchedule").data("todate")];var t=this.model.validateRoundtrip(e,!this.isDepartureTypeDomestic);return t.length?(this._handleErrorMessage(t),!1):e},_searchStopoverOrOpenjaw:function(){var e=this._createCommonCondition();e.arrival=this._getArrivalPort();var t=this.$(".item-destination-box"),n=[];e.toDates=_.reduce(t,function(e,t,i){var r=c(t);if(r.is(":visible")){var s=r.find(".stopoverSchedule").data("todate"),a=r.find(".isOpenjaw").is(":checked");n.push(a),a&&(s=""),e.push(s)}return e},[],this),_.contains(n,!0)&&(e.searchKind=D.OPENJAW);var i=this.model.validateStopoverOrOpenjaw(e,n,!this.isDepartureTypeDomestic);return i.length?(this._handleErrorMessage(i),!1):e},_getDeparturePort:function(){return this.$(".allDeparture").data("code")},_isOnewayOrRoundtrip:function(){return this.currentSearchKind===D.ROUNDTRIP||this.currentSearchKind===D.ONEWAY},_getArrivalPort:function(){return this._isOnewayOrRoundtrip()?this.$(".onewayOrRoundtripArrival").data("code"):this.$(".stopoverArrival").data("code")},hideDestination:function(e){var t=c(e.currentTarget).parents(".item-destination-box").data("index")-1,d=this.$(".item-destination-box"),h=this._getVisibleDestinations();if(_.each(_.range(t,h-1),function(e){var t=c(d.get(e)),i=c(d.get(e+1));this._setupDate(i.find(".stopoverSchedule").data("todate"),t.find(".stopoverSchedule"));var r=i.find(".isOpenjaw:checked").val(),s=t.find(".isOpenjaw"),a=t.find(".box-no-airplane");r&&1!==h?(s.prop("checked",!0),a.addClass("active"),this._hide(t.find(".item-schedule-01"))):(s.prop("checked",!1),a.removeClass("active"),this._show(t.find(".item-schedule-01")));var n=t.find(".stopoverDestination"),o=i.find(".stopoverDestination");n.data("code",o.data("code")||""),n.html(o.html())},this),2==h){this._hide(this.$(".link-delete-01"));var i=c(d.get(0));i.find(".isOpenjaw:checked").val()&&(i.find(".isOpenjaw").prop("checked",!1),i.find(".box-no-airplane").removeClass("active"),this._show(i.find(".item-schedule-01")))}var r=h-1,s=r-1;this._hide(c(d.get(r)));var a=c(d.get(s));this._show(this.$(".btn-add-box-01")),this._show(a.find(".item-schedule-01"));var n=a.find(".isOpenjaw"),o=a.find(".box-no-airplane");n.prop("checked",!1),o.removeClass("active"),this._hide(c(a.find(".box-no-airplane")))},showNextDestination:function(e){this._showDestination()},_showDestination:function(){var e=this.$(".item-destination-box"),t=this._getVisibleDestinations(),i=c(e.get(t-1)),r=t,s=c(e.get(t));this._show(i.find(".box-no-airplane")),this._show(s),this._show(this.$(".link-delete-01")),4===r&&this._hide(this.$(".btn-add-box-01"))},showOrHideOptionalCondition:function(e,t){var i=c(e.currentTarget);i.hasClass("active")?i.removeClass("active"):i.addClass("active")},toggleOpenjaw:function(e){var d,t=c(e.currentTarget),i=t.parents(".item-destination-box"),h=t.is(":checked"),l=i.data("index")-1,r=this.$(".item-destination-box");_.each(r,function(e,t){var i=t,r=c(e),s=r.find(".item-schedule-01"),a=s.find(".stopoverSchedule");if(a.length&&l===i){var n=r.find(".box-no-airplane");h?(n.addClass("active"),this._hide(s)):(n.removeClass("active"),this._show(s)),d=a.data("todate")}else if(a.length&&!h&&l<t){var o=a.data("todate");p(u(o),u(d))<0&&this._setupDate(d,a)}},this)},_getReverseDirections:function(){return this.isDepartureTypeDomestic?this.model.get("reverseDirections"):this.model.get("reverseDirectionsOverseas")},_getDestinations:function(){return this._isOnewayOrRoundtrip()?[this.$(".onewayOrRoundtripDestination").data("code")]:_.reduce(this.$(".stopoverDestination"),function(e,t){return c(t).is(":visible")&&e.push(c(t).data("code")),e},[])},_getMinorAges:function(e){var t=[],i=this.$(".minorAges").data("minorages");return i&&(t=_.map(i.split(","),function(e){return+e})),t},_clearParameter:function(){this.$(".searchKind[value=0]").prop("checked",!0);var e=this;_.defer(function(){e.$("select").prop("selectedIndex",0)}),this.$("input[type=checkbox]").prop("checked",!1)},_show:function(e){_.each(_.toArray(arguments),function(e){e.removeClass("none")})},_hide:function(e){_.each(_.toArray(arguments),function(e){e.addClass("none")})}}),C=skygate.util.namespace("airlink.view.sp.multi_search_form");C.AirFormView=s,C.AirFormRouterBase=e,C.AirFormModalBaseView=i,C.AirFormRouterForLp=t}(window,jQuery);